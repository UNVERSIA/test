<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¿›é£Ÿéšœç¢çœ¼åŠ¨é¢„æµ‹ç¨‹åº</title>

  <!-- å¼•å…¥ Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <!-- ONNX Runtime -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <!-- jsPsych ç›¸å…³è„šæœ¬ -->
  <script src="https://unpkg.com/jspsych@8.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-init-camera@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-calibrate@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-webgazer-validate@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/gh/jspsych/jspsych@jspsych@7.0.0/examples/js/webgazer/webgazer.js"></script>
  <script src="https://unpkg.com/@jspsych/extension-webgazer@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function@1.0.0"></script>

  <style>
    /* ==== å…¨å±€æ ·å¼ ==== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      font-family: 'Roboto', 'Microsoft YaHei', sans-serif;
      background: #f5f6f8;
      color: #333;
      overflow: hidden;
    }

    /* ==== é¡¶éƒ¨å¯¼èˆªæ  ==== */
    .header {
      width: 100%;
      background: linear-gradient(90deg, #2c3e50, #4b6082);
      padding: 15px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1001;
      display: flex;
      justify-content: center;
    }

    .header h1 {
      color: #fff;
      font-weight: 500;
      font-size: 1.6rem;
      letter-spacing: 1px;
    }

    /* ==== å†…å®¹å®¹å™¨ ==== */
    #jspsych-target {
      position: absolute;
      top: 70px;
      left: 0;
      width: 100%;
      height: calc(100vh - 70px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
        z-index: 1;
    }
    #jspsych-target .jspsych-display-element {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f6f8;
    }
    #jspsych-target .jspsych-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-height: 100%;
    }

    /* ==== å›¾ç‰‡å±•ç¤ºåŒº ==== */
    .stimulus-container {
      width: 80%;
      max-width: 1000px;
      height: 70vh;
      margin: 0 auto;
      padding: 20px;
      border-radius: 20px;
      background: #ffffff;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .stimulus-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    /* ==== åŒºåŸŸåˆ’åˆ† ==== */
    .left-region, .right-region {
      position: absolute;
      top: 20px;
      bottom: 20px;
      width: 50%;
      /* è°ƒè¯•æ—¶å–æ¶ˆæ³¨é‡Šä»¥æ˜¾ç¤ºåŒºåŸŸè¾¹ç•Œ */
      /* background: rgba(255, 0, 0, 0.1); */
    }
    .left-region {
      left: 20px;
    }
    .right-region {
      right: 20px;
    }

    /* ==== ä¸­å¤®å›ºå®šåå­— ==== */
    .central-fixation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      color: #555;
      -webkit-user-select: none;
      user-select: none;
      z-index: 999;
      display: none;
    }

    /* ==== çœ¼åŠ¨è¿½è¸ªæ³¨è§†ç‚¹ï¼ˆå·²ç¦ç”¨ï¼‰ ==== */
    .gaze-point {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      display: none !important; /* ç¡®ä¿å°çº¢ç‚¹è¢«éšè— */
    }

    /* ==== æŒ‰é’®æ ·å¼ ==== */
    button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      margin: 6px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .jspsych-html-button-response .jspsych-button-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ==== å±…ä¸­æ–‡å­—æ¨¡å— ==== */
    .centered-text {
      text-align: center;
      padding: 20px 30px;
      color: #444;
      line-height: 1.6;
      max-width: 800px;
    }
    .centered-text p {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* ==== é¡µè„š ==== */
    .footer {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: #888;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    /* ==== ç™»å½•è¡¨å•æ ·å¼ ==== */
    .login-container {
      width: 700px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin: 0 auto;
    }
    .login-container h2 {
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: 500;
    }
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    .login-button {
      background: linear-gradient(90deg, #2980b9, #3498db);
      border: none;
      color: #fff;
      padding: 14px 36px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .login-button:hover {
      background: linear-gradient(90deg, #2572a5, #2c82c2);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* æ–°å¢ï¼šå®éªŒæ¬¡æ•°æ˜¾ç¤ºæ ·å¼ */
    .session-display {
      background: #f0f7ff;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
      border: 2px solid #d0e4ff;
      font-size: 1.3rem;
      font-weight: 500;
    }
    .session-display span {
      color: #2980b9;
      font-weight: 600;
    }

    /* ==== æ•°æ®æŠ¥å‘Šæ ·å¼ ==== */
    .data-report {
      max-width: 800px;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      text-align: left;
      font-family: 'Courier New', monospace;
      max-height: 80vh;
      overflow-y: auto;
    }
    .data-report h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
      font-weight: 500;
    }
    .data-report pre {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .copy-button {
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .copy-button:hover {
      background: linear-gradient(90deg, #219653, #27ad60);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    .github-button {
      background: linear-gradient(90deg, #24292e, #2d3338);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .github-button:hover {
      background: linear-gradient(90deg, #1a1e21, #22272b);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }
    /* æ–°å¢ï¼šä¿å­˜æŒ‰é’®æ ·å¼ */
    .save-button {
      background: linear-gradient(90deg, #f39c12, #e67e22);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .save-button:hover {
      background: linear-gradient(90deg, #d35400, #e67e22);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* é€€å‡ºæŒ‰é’® */
    .exit-button {
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      border: none;
      color: #fff;
      padding: 12px 28px;
      text-align: center;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .exit-button:hover {
      background: linear-gradient(90deg, #c0392b, #a93226);
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    /* ==== çŠ¶æ€æ¶ˆæ¯ ==== */
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-loading {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    .status-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    /* éªŒè¯ç å¼¹çª— */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    .auth-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    .auth-content h3 {
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .auth-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    .auth-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .auth-button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }
    .auth-confirm {
      background: #27ae60;
      color: white;
    }
    .auth-confirm:hover {
      background: #219653;
    }
    .auth-cancel {
      background: #e74c3c;
      color: white;
    }
    .auth-cancel:hover {
      background: #c0392b;
    }
    .auth-error {
      color: #e74c3c;
      margin-top: 10px;
      display: none;
    }

    /* ==== æƒé™æç¤ºå’Œé”™è¯¯æç¤ºæ ·å¼ ==== */
    .permission-alert {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 2000;
      max-width: 90%;
      width: 500px;
      display: none;
    }

    .permission-alert h3 {
      color: #e74c3c;
      margin-bottom: 20px;
    }

    .permission-alert p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .permission-alert .warning {
      color: #e74c3c;
      font-weight: bold;
    }

    .permission-alert .browser-warning {
      background: #f8d7da;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    .permission-alert .protocol-warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    /* ==== åˆå§‹åŒ–çŠ¶æ€é¢æ¿ ==== */
    .init-status-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      z-index: 2000;
      font-size: 14px;
      display: none;
    }

    .init-status-panel h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #3498db;
      border-bottom: 1px solid #3498db;
      padding-bottom: 5px;
    }

    .init-status-panel .status-item {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .init-status-panel .status-label {
      font-weight: bold;
      margin-right: 10px;
    }

    .init-status-panel .status-value {
      color: #2ecc71;
    }

    .init-status-panel .status-error {
      color: #e74c3c;
    }

    .init-status-panel .status-warning {
      color: #f39c12;
    }

    .debug-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2001;
    }

    /* ==== é”™è¯¯å¤„ç†é¢æ¿ ==== */
    .error-panel {
      background: #f8d7da;
      border-left: 4px solid #e74c3c;
      padding: 15px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
      text-align: left;
    }

    .error-panel h4 {
      color: #721c24;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .error-panel ul {
      padding-left: 20px;
      margin-bottom: 10px;
    }

    .error-panel li {
      margin-bottom: 5px;
    }

    /* ==== æ•°æ®è¡¨æ ¼æ ·å¼ ==== */
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.9em;
      font-family: sans-serif;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }
    .results-table thead tr {
      background-color: #2980b9;
      color: #ffffff;
      text-align: left;
    }
    .results-table th,
    .results-table td {
      padding: 12px 15px;
      border: 1px solid #dddddd;
    }
    .results-table tbody tr {
      border-bottom: 1px solid #dddddd;
    }
    .results-table tbody tr:nth-of-type(even) {
      background-color: #f3f3f3;
    }
    .results-table tbody tr:last-of-type {
      border-bottom: 2px solid #2980b9;
    }

    /* ==== è°ƒè¯•ä¿¡æ¯é¢æ¿ ==== */
    .debug-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      z-index: 2000;
      font-size: 12px;
      display: none;
    }

    .debug-panel h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #3498db;
      border-bottom: 1px solid #3498db;
      padding-bottom: 5px;
    }

    .debug-panel .debug-item {
      margin-bottom: 8px;
    }

    .debug-panel .debug-label {
      font-weight: bold;
      margin-right: 10px;
    }

    .debug-panel .debug-value {
      color: #2ecc71;
    }

    .debug-panel .debug-error {
      color: #e74c3c;
    }

    /* ==== äººè„¸æ£€æµ‹æç¤º ==== */
    .face-detection-help {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
      text-align: center;
      z-index: 2000;
      max-width: 90%;
      width: 500px;
      display: none;
    }

    .face-detection-help h3 {
      color: #2980b9;
      margin-bottom: 20px;
    }

    .face-detection-help ul {
      text-align: left;
      margin: 20px 0;
      padding-left: 20px;
    }

    .face-detection-help li {
      margin-bottom: 10px;
    }

    .face-detection-help .camera-feed {
      width: 100%;
      height: 200px;
      background: #eee;
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .face-detection-help .camera-feed video {
      max-width: 100%;
      max-height: 100%;
    }

    .face-detection-help .retry-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 15px;
    }

    /* ==== é¢„æµ‹ç»“æœæ ·å¼ ==== */
    .prediction-result h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
    }

    .prediction-features h4 {
      color: #2c3e50;
      margin-bottom: 10px;
    }

    .prediction-features ul {
      padding-left: 20px;
    }

    .prediction-features li {
      margin-bottom: 8px;
    }
/* ==== è¯Šæ–­æŠ¥å‘Šæ ·å¼ ==== */
  .diagnostic-report {
    max-width: 800px;
    max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£çš„80% */
    overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    margin: 20px auto;
    text-align: left;
    font-family: 'Roboto', 'Microsoft YaHei', sans-serif;
  }

  .diagnostic-report h3 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
  }

  .diagnostic-report h4 {
    color: #2c3e50;
    margin-top: 20px;
    margin-bottom: 10px;
    font-size: 1.3em; /* å¢å¤§å»ºè®®æ ‡é¢˜å­—ä½“ */
  }

  .diagnostic-report ul {
    padding-left: 20px;
    margin-bottom: 15px;
  }

  .diagnostic-report li {
    margin-bottom: 8px;
    font-size: 1.1em; /* å¢å¤§å»ºè®®å†…å®¹å­—ä½“ */
    line-height: 1.6; /* å¢åŠ è¡Œé«˜æé«˜å¯è¯»æ€§ */
  }

  .report-disclaimer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
    font-size: 0.8em; /* ç¼©å°å…è´£å£°æ˜å­—ä½“ */
    color: #6c757d;
    line-height: 1.4; /* è°ƒæ•´è¡Œé«˜ */
  }

  /* ç¡®ä¿æ•´ä¸ªæŠ¥å‘ŠåŒºåŸŸå¯ä»¥æ»šåŠ¨ */
  .jspsych-content {
    overflow-y: auto; /* å…è®¸å†…å®¹åŒºåŸŸæ»šåŠ¨ */
    max-height: calc(100vh - 70px); /* å‡å»é¡¶éƒ¨å¯¼èˆªæ é«˜åº¦ */
  }

  /* ==== ç”¨æˆ·æ‰‹å†Œä¾§è¾¹æ æ ·å¼ ==== */
.user-manual-sidebar {
  position: fixed;
  top: 70px;
  left: -400px;
  width: 400px;
  height: calc(100vh - 70px);
  background: #fff;
  box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
  z-index: 999;
  transition: left 0.3s ease;
  overflow-y: auto;
  padding: 20px;
}

.user-manual-sidebar.active {
  left: 0;
}

.user-manual-toggle {
  position: fixed;
  top: 50%;
  left: 0;
  transform: translateY(-50%);
  background: #2c3e50;
  color: white;
  border: none;
  padding: 15px 10px;
  border-radius: 0 8px 8px 0;
  cursor: pointer;
  z-index: 998;
  font-size: 14px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transition: all 0.3s ease;
}

.user-manual-toggle:hover {
  background: #34495e;
  padding-left: 15px;
}

.user-manual-content {
  height: 100%;
}

.user-manual-content h2 {
  color: #2c3e50;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e9ecef;
}

.user-manual-content h3 {
  color: #2c3e50;
  margin: 20px 0 10px 0;
  font-size: 1.2em;
}

.user-manual-content p, .user-manual-content li {
  line-height: 1.6;
  margin-bottom: 10px;
  font-size: 14px;
}

.user-manual-content ul {
  padding-left: 20px;
  margin-bottom: 15px;
}

.user-manual-content .important {
  background: #fff3cd;
  padding: 10px;
  border-radius: 5px;
  border-left: 4px solid #ffc107;
  margin: 15px 0;
}

.user-manual-content .warning {
  background: #f8d7da;
  padding: 10px;
  border-radius: 5px;
  border-left: 4px solid #dc3545;
  margin: 15px 0;
}

.user-manual-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 997;
  display: none;
}

.user-manual-overlay.active {
  display: block;
}

.manual-close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #e74c3c;
  color: white;
  border: none;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.min-time-message {
  background: #d4edda;
  color: #155724;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  text-align: center;
  font-size: 12px;
  display: none;
}
  </style>
</head>

<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="header">
    <h1>è¿›é£Ÿéšœç¢çœ¼åŠ¨é¢„æµ‹ç¨‹åº</h1>
  </div>

  <!-- ç”¨æˆ·æ‰‹å†Œä¾§è¾¹æ  -->
<div class="user-manual-sidebar" id="user-manual-sidebar">
  <button class="manual-close-btn" id="manual-close-btn">Ã—</button>
  <div class="user-manual-content" id="user-manual-content">
    <h2>çœ¼åŠ¨æµ‹é‡å·¥å…·ç”¨æˆ·é€‚åº”æ‰‹å†Œ</h2>
    <div class="min-time-message" id="min-time-message">
      è¯·è‡³å°‘é˜…è¯»10ç§’åæ–¹å¯å…³é—­æ‰‹å†Œ
    </div>

    <h3>1. æµ‹é‡å‰çš„ç¯å¢ƒå‡†å¤‡</h3>
    <p><strong>æ¨èæµè§ˆå™¨ï¼š</strong>è¯·ä½¿ç”¨ Google Chrome æˆ– Microsoft Edge æµè§ˆå™¨è®¿é—®ç³»ç»Ÿã€‚</p>
    <div class="important">
      <strong>é‡è¦æç¤ºï¼š</strong>åœ¨æ•´ä¸ªæµ‹é‡å‘¨æœŸå†…ï¼Œè¯·å§‹ç»ˆä½¿ç”¨åŒä¸€æµè§ˆå™¨ï¼Œä¸å¯ä¸­é€”æ›´æ¢ï¼Œä»¥å…é€ æˆæ•°æ®ä¸¢å¤±æˆ–å¼‚å¸¸ã€‚
    </div>

    <p><strong>æ‘„åƒå¤´å‡†å¤‡ï¼š</strong>è¯·ç¡®ä¿æ‚¨çš„ç”µè„‘å†…ç½®æˆ–å¤–æ¥æ‘„åƒå¤´å¯æ­£å¸¸ä½¿ç”¨ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­å¼€å¯æ‘„åƒå¤´æƒé™ã€‚</p>
    <p><strong>æç¤ºï¼š</strong>å¼€å§‹å‰è¯·å…³é—­å…¶ä»–å¯èƒ½å ç”¨æ‘„åƒå¤´çš„è½¯ä»¶æˆ–ç½‘é¡µï¼ˆå¦‚å¾®ä¿¡ã€Zoomç­‰ï¼‰ï¼Œç¡®ä¿æ‘„åƒå¤´å¯è¢«æµ‹é‡ç½‘é¡µç‹¬å ä½¿ç”¨ã€‚</p>

    <p><strong>ç½‘ç»œç¯å¢ƒï¼š</strong>å»ºè®®ä½¿ç”¨ç¨³å®šã€é«˜é€Ÿçš„å®¶åº­å®½å¸¦æˆ–æ‰‹æœºçƒ­ç‚¹ï¼Œé¿å…åœ¨æµ‹é‡è¿‡ç¨‹ä¸­ç½‘ç»œå‘ç”Ÿä¸­æ–­ã€‚</p>
    <p>è‹¥é¡µé¢åŠ è½½ç¼“æ…¢æˆ–æŠ¥é”™ï¼šå¯å°è¯•æš‚æ—¶å…³é—­é˜²ç«å¢™æˆ–å®‰å…¨è½¯ä»¶ï¼ˆå¦‚360ã€ç”µè„‘ç®¡å®¶ï¼‰ï¼Œæˆ–åˆ‡æ¢ç½‘ç»œç¯å¢ƒååˆ·æ–°é‡è¯•ã€‚</p>

    <h3>2. æµ‹é‡æ“ä½œæµç¨‹</h3>
    <p>è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼Œä»¥ä¿è¯æ•°æ®æœ‰æ•ˆï¼š</p>
    <ul>
      <li><strong>a) è®¿é—®ç³»ç»Ÿï¼š</strong>åœ¨åœ°å€æ è¾“å…¥æµ‹é‡é¡µé¢åœ°å€å¹¶æ‰“å¼€é¡µé¢ï¼ˆé¦–æ¬¡åŠ è½½å¯èƒ½è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œå¿…è¦æ—¶å¯åˆ·æ–°é‡è¯•ï¼‰ã€‚</li>
      <li><strong>b) ç™»å½•ä¸ä¿¡æ¯å¡«å†™ï¼š</strong>è¾“å…¥æ‚¨çš„å”¯ä¸€å®éªŒIDï¼›å¦‚å®å¡«å†™æ€§åˆ«ã€å¹´é¾„ç­‰åŸºæœ¬ä¿¡æ¯ï¼›ç‚¹å‡»ã€å¼€å§‹å®éªŒã€‘è¿›å…¥ç³»ç»Ÿã€‚</li>
      <li><strong>c) æƒé™æˆäºˆï¼š</strong>é¦–æ¬¡ä½¿ç”¨æ—¶ï¼Œæµè§ˆå™¨ä¼šè¯·æ±‚æ‘„åƒå¤´æƒé™ï¼Œè¯·ç‚¹å‡»"å…è®¸"ã€‚</li>
      <li><strong>d) æ ¡å‡†ä¸æµ‹é‡ï¼š</strong>è¯·ä¿æŒé¢éƒ¨ä½äºç•Œé¢ä¸­çš„ç»¿è‰²æ ¡å‡†æ¡†å†…ï¼Œå¹¶å°½é‡ä¿æŒå¤´éƒ¨ç¨³å®šï¼›æŒ‰å±å¹•æç¤ºå®Œæˆæ³¨è§†ç‚¹æ ¡å‡†åŠåç»­è‡ªç”±æµè§ˆä»»åŠ¡ã€‚</li>
      <li><strong>e) æ•°æ®æäº¤ï¼š</strong>æµ‹é‡ç»“æŸåç³»ç»Ÿå°†è‡ªåŠ¨ä¸Šä¼ æ•°æ®ï¼›è¯·è€å¿ƒç­‰å¾…ä¸Šä¼ å®Œæˆï¼Œç›´è‡³å‡ºç°ç»“æŸæç¤ºåå†å…³é—­é¡µé¢ã€‚</li>
    </ul>
    <div class="warning">
      å¦‚ç•Œé¢æç¤º"æ•°æ®ä¸Šä¼ å¤±è´¥"ï¼Œè¯·æŒ‰æç¤ºæ‰‹åŠ¨ä¸‹è½½æ•°æ®æ–‡ä»¶ï¼Œå¹¶åŠæ—¶æäº¤ç»™å®éªŒè´Ÿè´£äººã€‚
    </div>

    <h3>3. å¸¸è§é—®é¢˜å¤„ç†</h3>
    <ul>
      <li>å¦‚åå¤å‡ºç°"The experiment failed to load..."ç­‰é”™è¯¯æç¤ºï¼Œå°è¯•åˆ·æ–°é¡µé¢æˆ–æ›´æ¢ç½‘ç»œç¯å¢ƒåé‡æ–°ç™»å½•ï¼›</li>
      <li>å¦‚é‡æŒç»­æŠ€æœ¯éšœç¢ï¼Œè¯·è”ç³»å®éªŒæ”¯æŒäººå‘˜å¹¶æä¾›æ‚¨çš„IDä¸é—®é¢˜æè¿°ã€‚</li>
    </ul>

    <h3>4. æ³¨æ„äº‹é¡¹</h3>
    <ul>
      <li>è¯·åœ¨å®‰é™ã€å…‰çº¿ç¨³å®šçš„ç¯å¢ƒä¸‹è¿›è¡Œæµ‹é‡ï¼›</li>
      <li>æµ‹é‡è¿‡ç¨‹ä¸­è¯·å°½é‡é¿å…å¤§å¹…ç§»åŠ¨æˆ–ä¸ä»–äººäº¤è°ˆï¼›</li>
      <li>å¦‚æœ‰ä»»ä½•èº«ä½“ä¸é€‚æˆ–ä¸»è§‚å›°éš¾ï¼Œå¯æš‚åœä»»åŠ¡å¹¶è”ç³»å®éªŒäººå‘˜ã€‚</li>
    </ul>

    <h3>5. è”ç³»æˆ‘ä»¬</h3>
    <p>å¦‚æ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æŠ€æœ¯æ”¯æŒï¼š2126660684@qq.com</p>

    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
      <strong>------ç¥æ‚¨æµ‹é‡é¡ºåˆ©ï¼------</strong>
    </div>
  </div>
</div>

<!-- æ‰‹å†Œåˆ‡æ¢æŒ‰é’® -->
<button class="user-manual-toggle" id="user-manual-toggle">ğŸ“– ç”¨æˆ·æ‰‹å†Œ</button>

<!-- é®ç½©å±‚ -->
<div class="user-manual-overlay" id="user-manual-overlay"></div>

  <!-- ä¸­å¤®å›ºå®šåå­— -->
  <div id="central-fixation" class="central-fixation">+</div>

  <!-- çœ¼åŠ¨è¿½è¸ªæ³¨è§†ç‚¹ï¼ˆå·²ç¦ç”¨ï¼‰ -->
  <div id="gaze-point" class="gaze-point"></div>

  <!-- éªŒè¯ç å¼¹çª— -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-content">
      <h3>è¯·è¾“å…¥éªŒè¯ç ä»¥æŸ¥çœ‹GitHubè®°å½•</h3>
      <input type="text" class="auth-input" id="auth-code" placeholder="è¾“å…¥éªŒè¯ç " />
      <div class="auth-error" id="auth-error">éªŒè¯ç é”™è¯¯ï¼Œæ— æƒé™æŸ¥çœ‹</div>
      <div class="auth-buttons">
        <button class="auth-button auth-cancel" id="auth-cancel">è¿”å›</button>
        <button class="auth-button auth-confirm" id="auth-confirm">ç¡®è®¤</button>
      </div>
    </div>
  </div>

  <!-- æ‘„åƒå¤´æƒé™æç¤º -->
  <div id="camera-permission-alert" class="permission-alert" style="display:none;"></div>

  <!-- äººè„¸æ£€æµ‹å¸®åŠ© -->
  <div class="face-detection-help" id="face-detection-help">
    <h3>äººè„¸æ£€æµ‹é—®é¢˜</h3>
    <p>ç³»ç»Ÿæ— æ³•æ£€æµ‹åˆ°æ‚¨çš„äººè„¸ï¼Œè¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š</p>
    <ul>
      <li>ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…èƒŒå…‰æˆ–è¿‡æš—ç¯å¢ƒ</li>
      <li>è°ƒæ•´æ‘„åƒå¤´ä½ç½®ï¼Œä½¿æ‚¨çš„è„¸éƒ¨æ¸…æ™°å¯è§</li>
      <li>ç§»é™¤å¯èƒ½é®æŒ¡è„¸éƒ¨çš„ç‰©å“ï¼ˆå¦‚å¸½å­ã€å¢¨é•œï¼‰</li>
      <li>å°è¯•è°ƒæ•´ä¸æ‘„åƒå¤´çš„è·ç¦»ï¼ˆçº¦50-70å˜ç±³ï¼‰</li>
    </ul>
    <div class="camera-feed" id="camera-preview">
      <p>æ‘„åƒå¤´é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
    </div>
    <button class="retry-button" id="retry-face-detection">é‡è¯•æ£€æµ‹</button>
  </div>

  <!-- åˆå§‹åŒ–çŠ¶æ€é¢æ¿ -->
  <div class="init-status-panel" id="init-status-panel">
    <h4>çœ¼åŠ¨è¿½è¸ªåˆå§‹åŒ–çŠ¶æ€</h4>
    <div class="status-item">
      <span class="status-label">æ‘„åƒå¤´çŠ¶æ€:</span>
      <span class="status-value" id="status-camera">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">WebgazerçŠ¶æ€:</span>
      <span class="status-value" id="status-webgazer">æœªåˆå§‹åŒ–</span>
    </div>
    <div class="status-item">
      <span class="status-label">æƒé™çŠ¶æ€:</span>
      <span class="status-value" id="status-permission">æœªçŸ¥</span>
    </div>
    <div class="status-item">
      <span class="status-label">å®‰å…¨ç¯å¢ƒ:</span>
      <span class="status-value" id="status-security">æ£€æµ‹ä¸­...</span>
    </div>
    <div class="status-item">
      <span class="status-label">äººè„¸æ£€æµ‹:</span>
      <span class="status-value" id="status-face">æœªæ£€æµ‹</span>
    </div>
    <div class="status-item">
      <span class="status-label">é”™è¯¯ä¿¡æ¯:</span>
      <span class="status-value" id="status-error">æ— </span>
    </div>
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
  <div class="debug-panel" id="debug-panel">
    <h4>çœ¼åŠ¨æ•°æ®è°ƒè¯•ä¿¡æ¯</h4>
    <div class="debug-item">
      <span class="debug-label">å½“å‰è¯•æ¬¡:</span>
      <span class="debug-value" id="debug-trial">-</span>
    </div>
    <div class="debug-item">
      <span class="debug-label">æ•°æ®ç‚¹æ•°é‡:</span>
      <span class="debug-value" id="debug-data-points">0</span>
    </div>
    <div class="debug-item">
      <span class="debug-label">å·¦åŒºåŸŸæ³¨è§†:</span>
      <span class="debug-value" id="debug-left-gaze">0ms</span>
    </div>
    <div class="debug-item">
      <span class="debug-label">å³åŒºåŸŸæ³¨è§†:</span>
      <span class="debug-value" id="debug-right-gaze">0ms</span>
    </div>
    <div class="debug-item">
      <span class="debug-label">é¦–è§†ç‚¹åŒºåŸŸ:</span>
      <span class="debug-value" id="debug-first-fixation">-</span>
    </div>
    <div class="debug-item">
      <span class="debug-label">å›è§†æ¬¡æ•°:</span>
      <span class="debug-value" id="debug-regressions">0</span>
    </div>
  </div>

  <button class="debug-toggle" id="debug-toggle">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>

  <!-- jsPsych æ¸²æŸ“ç›®æ ‡å®¹å™¨ -->
  <div id="jspsych-target"></div>

  <!-- é¡µè„š -->
  <div class="footer">2025 åŒ—äº¬å¸ˆèŒƒå¤§å­¦ Eyeâ€”ED é¡¹ç›®ç»„è”åˆå‡ºå“ã€‚</div>

  <script>
/* ==== ç”¨æˆ·æ‰‹å†ŒåŠŸèƒ½ ==== */
let manualOpenTime = null;
const MIN_READING_TIME = 10000; // æœ€å°é˜…è¯»æ—¶é—´10ç§’

// åˆå§‹åŒ–ç”¨æˆ·æ‰‹å†ŒåŠŸèƒ½
function initUserManual() {
  const sidebar = document.getElementById('user-manual-sidebar');
  const toggleBtn = document.getElementById('user-manual-toggle');
  const closeBtn = document.getElementById('manual-close-btn');
  const overlay = document.getElementById('user-manual-overlay');
  const minTimeMessage = document.getElementById('min-time-message');

  // è‡ªåŠ¨å±•å¼€æ‰‹å†Œ
  setTimeout(() => {
    openManual();
  }, 1000);

  // åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  toggleBtn.addEventListener('click', function() {
    if (sidebar.classList.contains('active')) {
      closeManual();
    } else {
      openManual();
    }
  });

  // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  closeBtn.addEventListener('click', function() {
    const currentTime = Date.now();
    const readingTime = currentTime - manualOpenTime;

    if (readingTime < MIN_READING_TIME) {
      minTimeMessage.style.display = 'block';
      return;
    }

    closeManual();
  });

  // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
  overlay.addEventListener('click', function() {
    const currentTime = Date.now();
    const readingTime = currentTime - manualOpenTime;

    if (readingTime < MIN_READING_TIME) {
      minTimeMessage.style.display = 'block';
      return;
    }

    closeManual();
  });

  function openManual() {
    sidebar.classList.add('active');
    overlay.classList.add('active');
    manualOpenTime = Date.now();
    minTimeMessage.style.display = 'none';

    // 10ç§’åéšè—æœ€å°é˜…è¯»æ—¶é—´æç¤º
    setTimeout(() => {
      minTimeMessage.style.display = 'none';
    }, MIN_READING_TIME);
  }

  function closeManual() {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // ç¡®ä¿jsPsychç›®æ ‡å®¹å™¨åœ¨æ‰‹å†Œä¸‹æ–¹
    const jsPsychTarget = document.getElementById('jspsych-target');
    if (jsPsychTarget) {
      jsPsychTarget.style.zIndex = '1';
    }
  });
}

// åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ‰‹å†ŒåŠŸèƒ½
document.addEventListener('DOMContentLoaded', initUserManual);
    /* ==== æ¨¡å‹ç›¸å…³å˜é‡ ==== */
let onnxSession = null;
let preprocessingConfig = null;
let modelLoaded = false;
    /* ==== ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ ==== */
    let userInfo = null;
    let cameraPermissionDenied = false; // æ‘„åƒå¤´æƒé™çŠ¶æ€
    let webgazerInitialized = false;   // Webgazeråˆå§‹åŒ–çŠ¶æ€
    let gazeData = []; // å­˜å‚¨æ¯ä¸ªè¯•æ¬¡çš„çœ¼åŠ¨æ•°æ®
    let gazeUpdateInterval; // çœ¼åŠ¨æ•°æ®æ›´æ–°é—´éš”
    let faceDetectionAttempts = 0; // äººè„¸æ£€æµ‹å°è¯•æ¬¡æ•°
/* ==== è¯Šæ–­æŠ¥å‘Šæ¨¡æ¿ ==== */
const diagnosticReports = {
  normal: `
    <div class="diagnostic-report">
      <h3>è¿›é£Ÿéšœç¢é£é™©çœ¼åŠ¨æµ‹è¯„æŠ¥å‘Š</h3>
      <p><strong>æŠ¥å‘Šç¼–å·ï¼š</strong>REPORT-{reportId}</p>
      <p><strong>æµ‹è¯„æ—¥æœŸï¼š</strong>{reportDate}</p>
      <p><strong>å§“åï¼š</strong>{subjectId}</p>

      <p>å°Šæ•¬çš„å‚ä¸è€…ï¼Œæ„Ÿè°¢æ‚¨å®Œæˆæœ¬æ¬¡æµ‹è¯„ã€‚æ‚¨çš„æ•´ä½“è¿›é£Ÿéšœç¢é£é™©ç­‰çº§è¯„ä¼°ä¸ºï¼š<strong>å¥åº·</strong>ã€‚</p>

      <p>æ‚¨çš„æ³¨æ„æ¨¡å¼ä¸å¥åº·äººç¾¤ç›¸ä¼¼ï¼Œæœªæ˜¾ç¤ºå‡ºæ˜¾è‘—çš„è¿›é£Ÿéšœç¢ç›¸å…³è®¤çŸ¥åå·®ã€‚</p>

      <h4>æ ¹æ®æ‚¨çš„é£é™©ç­‰çº§ï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹å‚è€ƒå»ºè®®ï¼š</h4>
      <ul>
        <li><strong>ç¥è´ºæ‚¨ï¼æ‚¨çš„è®¤çŸ¥ä¹ æƒ¯ç›®å‰éå¸¸å¥åº·ã€‚è¯·ç»§ç»­ä¿æŒå‡è¡¡çš„é¥®é£Ÿå’Œç§¯æçš„èº«ä½“æ„è±¡ã€‚</li>
        <li><strong>å»ºè®®ï¼š</strong>
          <ul>
            <li>ä¿æŒå½“å‰è‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯ã€‚</li>
            <li>å¯ä»¥é˜…è¯»ç›¸å…³ç§‘æ™®èµ„æ–™ï¼Œå¢è¿›å¯¹å¿ƒç†å¥åº·çš„è®¤è¯†ï¼Œèµ·åˆ°é¢„é˜²ä½œç”¨ã€‚</li>
            <li>å¦‚æœæ‚¨æœªæ¥æ„Ÿåˆ°å‹åŠ›æˆ–å›°æ‰°ï¼Œéšæ—¶å¯ä»¥é‡æ–°æµ‹è¯„ã€‚</li>
          </ul>
        </li>
      </ul>

      <div class="report-disclaimer">
        <p><strong>å…è´£å£°æ˜ï¼š</strong>æœ¬æŠ¥å‘Šç”±äººå·¥æ™ºèƒ½ç®—æ³•ç”Ÿæˆï¼Œä»…ä½œä¸ºç­›æŸ¥å’Œå‚è€ƒå·¥å…·ï¼Œä¸èƒ½ä½œä¸ºä¸´åºŠè¯Šæ–­çš„å”¯ä¸€ä¾æ®ã€‚æœ€ç»ˆçš„è¯Šæ–­å¿…é¡»ç”±åˆæ ¼çš„åŒ»ç–—ä¸“ä¸šäººå‘˜é€šè¿‡é¢è°ˆå’Œè¯„ä¼°åšå‡ºã€‚</p>
        <p><strong>éšç§ä¿æŠ¤ï¼š</strong>æ‚¨çš„æ‰€æœ‰æµ‹è¯„æ•°æ®éƒ½å°†è¢«ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºä¸ºæ‚¨ç”Ÿæˆæ­¤æŠ¥å‘Šã€‚</p>
        <p><strong>è·å–å¸®åŠ©ï¼š</strong>å…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š12356</p>
        <p>æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ã€‚å…³çˆ±å¿ƒç†å¥åº·ï¼Œæ˜¯çˆ±è‡ªå·±æœ€é‡è¦çš„ä¸€æ­¥ã€‚</p>
      </div>
    </div>
  `,

  abnormal: `
    <div class="diagnostic-report">
      <h3>è¿›é£Ÿéšœç¢é£é™©çœ¼åŠ¨æµ‹è¯„æŠ¥å‘Š</h3>
      <p><strong>æŠ¥å‘Šç¼–å·ï¼š</strong>REPORT-{reportId}</p>
      <p><strong>æµ‹è¯„æ—¥æœŸï¼š</strong>{reportDate}</p>
      <p><strong>å§“åï¼š</strong>{subjectId}</p>

      <p>å°Šæ•¬çš„å‚ä¸è€…ï¼Œæ„Ÿè°¢æ‚¨å®Œæˆæœ¬æ¬¡æµ‹è¯„ã€‚æ‚¨çš„æ•´ä½“è¿›é£Ÿéšœç¢é£é™©ç­‰çº§è¯„ä¼°ä¸ºï¼š<strong>å¼‚å¸¸</strong>ã€‚</p>

      <p>æ‚¨çš„æ³¨æ„æ¨¡å¼æ˜¾ç¤ºå‡ºæ˜æ˜¾çš„è¿›é£Ÿéšœç¢è®¤çŸ¥åå·®ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå’¨è¯¢æˆ–è¯„ä¼°ã€‚</p>

      <h4>æ ¹æ®æ‚¨çš„é£é™©ç­‰çº§ï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹å‚è€ƒå»ºè®®ï¼š</h4>
      <ul>
        <li><strong>æ‚¨çš„è®¤çŸ¥æ¨¡å¼è¡¨æ˜ï¼Œé£Ÿç‰©å’Œä½“å‹é—®é¢˜å¯èƒ½å·²å¯¹æ‚¨é€ æˆäº†ä¸€å®šå›°æ‰°ï¼Œå¹¶å½±å“äº†æ‚¨çš„æ³¨æ„åŠ›åˆ†é…ã€‚</li>
        <li><strong>å»ºè®®ï¼š</strong>
          <ul>
            <li><strong>ä¸“ä¸šå’¨è¯¢ï¼š</strong>æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨ä¸å¿ƒç†å’¨è¯¢å¸ˆæˆ–è¾…å¯¼å‘˜è¿›è¡Œä¸€æ¬¡è°ˆè¯ã€‚ä»–ä»¬å¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è¯„ä¼°å’Œæ”¯æŒã€‚è¿™å¹¶ä¸æ˜¯ä¸€ä»¶å¯æ€•çš„äº‹ï¼Œè€Œæ˜¯å…³çˆ±è‡ªå·±çš„è¡¨ç°ã€‚</li>
            <li><strong>è¡ŒåŠ¨æ­¥éª¤ï¼š</strong>æ‚¨å¯ä»¥è”ç³»ï¼šå…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š12356 æˆ– åŒ—äº¬å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š010-82951332ã€‚</li>
            <li><strong>é¿å…ç‹¬è‡ªæŒ£æ‰ï¼š</strong>ä¸ä¸€ä½æ‚¨ä¿¡ä»»çš„æœ‹å‹æˆ–å®¶äººèŠèŠæ‚¨çš„æ„Ÿå—ã€‚</li>
          </ul>
        </li>
      </ul>

      <div class="report-disclaimer">
        <p><strong>å…è´£å£°æ˜ï¼š</strong>æœ¬æŠ¥å‘Šç”±äººå·¥æ™ºèƒ½ç®—æ³•ç”Ÿæˆï¼Œä»…ä½œä¸ºç­›æŸ¥å’Œå‚è€ƒå·¥å…·ï¼Œä¸èƒ½ä½œä¸ºä¸´åºŠè¯Šæ–­çš„å”¯ä¸€ä¾æ®ã€‚æœ€ç»ˆçš„è¯Šæ–­å¿…é¡»ç”±åˆæ ¼çš„åŒ»ç–—ä¸“ä¸šäººå‘˜é€šè¿‡é¢è°ˆå’Œè¯„ä¼°åšå‡ºã€‚</p>
        <p><strong>éšç§ä¿æŠ¤ï¼š</strong>æ‚¨çš„æ‰€æœ‰æµ‹è¯„æ•°æ®éƒ½å°†è¢«ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºä¸ºæ‚¨ç”Ÿæˆæ­¤æŠ¥å‘Šã€‚</p>
        <p><strong>è·å–å¸®åŠ©ï¼š</strong>å…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š12356</p>
        <p>æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ã€‚å…³çˆ±å¿ƒç†å¥åº·ï¼Œæ˜¯çˆ±è‡ªå·±æœ€é‡è¦çš„ä¸€æ­¥ã€‚</p>
      </div>
    </div>
  `
};
    /* ==== çœ¼åŠ¨æ•°æ®åˆ†æå˜é‡ ==== */
    let containerRect = null; // å­˜å‚¨å›¾ç‰‡å®¹å™¨ä½ç½®ä¿¡æ¯
    let analysisResults = {
      food: {
        dwellTime: 0, // æ³¨è§†æ—¶é—´ï¼ˆé«˜çƒ­é‡-ä½çƒ­é‡ï¼‰
        firstFixation: 0, // é¦–è§†ç‚¹æ•°ç›®ï¼ˆé«˜çƒ­é‡-ä½çƒ­é‡ï¼‰
        regressionCount: 0 // å›è§†æ¬¡æ•°
      },
      body: {
        dwellTime: 0, // æ³¨è§†æ—¶é—´ï¼ˆèƒ–å­-ç˜¦å­ï¼‰
        firstFixation: 0, // é¦–è§†ç‚¹æ•°ç›®ï¼ˆèƒ–å­-ç˜¦å­ï¼‰
        regressionCount: 0 // å›è§†æ¬¡æ•°
      }
    };

    /* ==== GitHub API ä¸­è½¬é…ç½® ==== */
    const API_BASE_URL = 'https://ok.edemi-lab.online/api/gh-eye';

    /* åˆå§‹åŒ– jsPsych */
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      extensions: [
        {
          type: jsPsychExtensionWebgazer,
          params: {
            capture_events: ['gaze'], // æ•è·çœ¼åŠ¨äº‹ä»¶
            sampling_rate: 50 // æ¯ç§’é‡‡æ ·50æ¬¡
          }
        }
      ],
      on_trial_finish: function(data) {
        // åœ¨æ¯ä¸ªè¯•æ¬¡ç»“æŸæ—¶è®°å½•é¢å¤–ä¿¡æ¯
        if (data.task === 'view') {
          console.log(`è¯•æ¬¡ ${data.trial_index} å®Œæˆ:`, data);
        }
      },
      on_finish: function() {
        // å®éªŒç»“æŸæ—¶åœæ­¢éŸ³ä¹
        if (window.globalAudio && !window.globalAudio.paused) {
          window.globalAudio.pause();
        }
      }
    });

    /* ==== çŠ¶æ€æ›´æ–°å‡½æ•° ==== */
    function updateInitStatus(field, value, isError = false) {
      const element = document.getElementById(`status-${field}`);
      if (element) {
        element.textContent = value;
        element.className = isError ? 'status-error' : 'status-value';
      }
    }

    // æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯
    document.getElementById('debug-toggle').addEventListener('click', function() {
      const panel = document.getElementById('debug-panel');
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        this.textContent = 'æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯';
      } else {
        panel.style.display = 'block';
        this.textContent = 'éšè—è°ƒè¯•ä¿¡æ¯';
      }
    });

    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
    function updateDebugInfo(trial, dataPoints, leftDwell, rightDwell, firstFixation, regressions) {
      document.getElementById('debug-trial').textContent = trial;
      document.getElementById('debug-data-points').textContent = dataPoints;
      document.getElementById('debug-left-gaze').textContent = `${leftDwell}ms`;
      document.getElementById('debug-right-gaze').textContent = `${rightDwell}ms`;
      document.getElementById('debug-first-fixation').textContent = firstFixation;
      document.getElementById('debug-regressions').textContent = regressions;
    }

    /* ==== äººè„¸æ£€æµ‹å‡½æ•° ==== */
    async function checkFaceDetection() {
      updateInitStatus('face', 'æ£€æµ‹ä¸­...');

      return new Promise((resolve) => {
        let detected = false;
        let attempts = 0;
        const maxAttempts = 10;

        const checkInterval = setInterval(() => {
          attempts++;

          if (webgazer && webgazer.getTracker()) {
            const tracker = webgazer.getTracker();
            if (tracker.isUserVisible()) {
              detected = true;
              clearInterval(checkInterval);
              updateInitStatus('face', 'æ£€æµ‹æˆåŠŸ');
              resolve(true);
            }
          }

          if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            updateInitStatus('face', 'æ£€æµ‹å¤±è´¥', true);
            resolve(false);
          }
        }, 500);
      });
    }

    // æ˜¾ç¤ºäººè„¸æ£€æµ‹å¸®åŠ©
    function showFaceDetectionHelp() {
      const helpEl = document.getElementById('face-detection-help');
      helpEl.style.display = 'block';

      // å°è¯•æ˜¾ç¤ºæ‘„åƒå¤´é¢„è§ˆ
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            const previewEl = document.getElementById('camera-preview');
            previewEl.innerHTML = '';
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            previewEl.appendChild(video);
          })
          .catch(err => {
            console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
          });
      }

      // é‡è¯•æŒ‰é’®äº‹ä»¶
      document.getElementById('retry-face-detection').addEventListener('click', async () => {
        helpEl.style.display = 'none';
        faceDetectionAttempts++;

        // æœ€å¤šå°è¯•3æ¬¡
        if (faceDetectionAttempts <= 3) {
          const detected = await checkFaceDetection();
          if (detected) {
            // ç»§ç»­å®éªŒ
            if (window.resumeExperiment) {
              window.resumeExperiment();
            }
          } else {
            // å†æ¬¡æ˜¾ç¤ºå¸®åŠ©
            showFaceDetectionHelp();
          }
        } else {
          // è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œè·³è¿‡çœ¼åŠ¨è¿½è¸ª
          cameraPermissionDenied = true;
          if (window.resumeExperiment) {
            window.resumeExperiment();
          }
        }
      });
    }

    /* ==== æ‘„åƒå¤´æƒé™æ£€æµ‹å’Œé”™è¯¯å¤„ç†å‡½æ•° ==== */
    async function checkCameraPermission() {
      // æ›´æ–°çŠ¶æ€
      updateInitStatus('camera', 'æ£€æµ‹ä¸­...');
      updateInitStatus('permission', 'æ£€æµ‹ä¸­...');
      updateInitStatus('security', 'æ£€æµ‹ä¸­...');

      // 1. æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨ç¯å¢ƒï¼ˆHTTPSæˆ–localhostï¼‰
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
      updateInitStatus('security', isSecure ? 'å®‰å…¨' : 'ä¸å®‰å…¨', !isSecure);

      // 2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåª’ä½“è®¾å¤‡
      const hasMediaDevices = 'mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices;
      updateInitStatus('camera', hasMediaDevices ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ', !hasMediaDevices);

      // 3. å°è¯•è·å–æ‘„åƒå¤´æƒé™
      let hasPermission = false;
      try {
        if (hasMediaDevices) {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          hasPermission = true;
          // å…³é—­æµ‹è¯•æµ
          stream.getTracks().forEach(track => track.stop());
        }
      } catch (error) {
        console.error('æ‘„åƒå¤´æƒé™æ£€æµ‹å¤±è´¥:', error);
        updateInitStatus('error', error.message || error.toString(), true);
      }

      updateInitStatus('permission', hasPermission ? 'å·²æˆäºˆ' : 'æœªæˆäºˆ', !hasPermission);

      return {
        hasPermission,
        isSecure,
        hasMediaDevices
      };
    }

    function showPermissionError(status) {
      const alertEl = document.getElementById('camera-permission-alert');

      let alertHTML = `
        <h3>æ‘„åƒå¤´æƒé™é—®é¢˜</h3>
        ${!status.hasMediaDevices ? `
          <div class="browser-warning">
            <p class="warning">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½</p>
            <p>è¯·ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„Chromeã€Firefoxæˆ–Edgeæµè§ˆå™¨å‚ä¸å®éªŒã€‚</p>
          </div>
        ` : ''}

        ${!status.isSecure ? `
          <div class="protocol-warning">
            <p class="warning">å½“å‰ç¯å¢ƒä¸å®‰å…¨</p>
            <p>æ‘„åƒå¤´åŠŸèƒ½éœ€è¦HTTPSå®‰å…¨è¿æ¥æˆ–æœ¬åœ°ç¯å¢ƒ(localhost)ã€‚</p>
            <p>å½“å‰åè®®: ${location.protocol}</p>
          </div>
        ` : ''}

        ${status.hasMediaDevices && status.isSecure && !status.hasPermission ? `
          <p>å®éªŒéœ€è¦ä½¿ç”¨æ‚¨çš„æ‘„åƒå¤´è¿›è¡Œçœ¼åŠ¨è¿½è¸ªã€‚</p>
          <p>æ‚¨å°šæœªæˆäºˆæ‘„åƒå¤´æƒé™æˆ–æƒé™å·²è¢«æ‹’ç»ã€‚</p>
          <div class="instructions">
            <p class="warning">è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œ:</p>
            <ol>
              <li>ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„æ‘„åƒå¤´å›¾æ ‡</li>
              <li>é€‰æ‹©"å§‹ç»ˆå…è®¸æ­¤ç½‘ç«™ä½¿ç”¨æ‘„åƒå¤´"</li>
              <li>åˆ·æ–°é¡µé¢</li>
            </ol>
          </div>
        ` : ''}

        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
          <button id="reload-btn" class="auth-confirm auth-button">åˆ·æ–°é¡µé¢</button>
          <button id="continue-btn" class="auth-cancel auth-button">ç»§ç»­å®éªŒ(æ— çœ¼åŠ¨)</button>
        </div>
      `;

      alertEl.innerHTML = alertHTML;
      alertEl.style.display = 'block';

      // æ·»åŠ äº‹ä»¶å¤„ç†
      document.getElementById('reload-btn').addEventListener('click', () => {
        location.reload();
      });

      document.getElementById('continue-btn').addEventListener('click', function() {
        alertEl.style.display = 'none';
        // è®¾ç½®æ ‡å¿—å…è®¸å®éªŒç»§ç»­ï¼ˆæ— çœ¼åŠ¨åŠŸèƒ½ï¼‰
        cameraPermissionDenied = true;
        // ç»§ç»­æ‰§è¡Œå®éªŒæµç¨‹
        if (window.resumeExperiment) {
          window.resumeExperiment();
        }
      });
    }

    /* ==== çœ¼åŠ¨æ•°æ®åˆ†æå‡½æ•° ==== */
    // åˆ¤æ–­æ³¨è§†ç‚¹æ‰€åœ¨çš„åŒºåŸŸ
    function getGazeRegion(x, y) {
      if (!containerRect) {
        console.error('å®¹å™¨ä½ç½®ä¿¡æ¯æœªè®¾ç½®');
        return 'outside';
      }

      // æ£€æŸ¥æ˜¯å¦åœ¨å®¹å™¨å†…
      if (x < containerRect.left || x > containerRect.right ||
          y < containerRect.top || y > containerRect.bottom) {
        return 'outside';
      }

      // è®¡ç®—ç›¸å¯¹ä½ç½®
      const relativeX = x - containerRect.left;
      const containerWidth = containerRect.right - containerRect.left;

      // åˆ¤æ–­å·¦å³åŒºåŸŸ
      if (relativeX < containerWidth / 2) {
        return 'left';
      } else {
        return 'right';
      }
    }

    // åˆ†æçœ¼åŠ¨æ•°æ®
    function analyzeGazeData(gazeData, imageType, imageAttribute) {
      let leftDwellTime = 0;
      let rightDwellTime = 0;
      let firstFixation = null;
      let regressions = 0;

      // è®¡ç®—æ³¨è§†æ—¶é—´
      gazeData.forEach(gaze => {
        const region = getGazeRegion(gaze.x, gaze.y);
        if (region === 'left') {
          leftDwellTime += 20; // æ¯20msä¸€ä¸ªé‡‡æ ·ç‚¹
        } else if (region === 'right') {
          rightDwellTime += 20;
        }
      });

      // è®¡ç®—é¦–è§†ç‚¹
      if (gazeData.length > 0) {
        const firstRegion = getGazeRegion(gazeData[0].x, gazeData[0].y);
        firstFixation = firstRegion;
      }

      // è®¡ç®—å›è§†æ¬¡æ•°
      let lastRegion = null;
      let lastTransitionTime = null;

      gazeData.forEach((gaze, index) => {
        const currentRegion = getGazeRegion(gaze.x, gaze.y);

        // æ£€æµ‹åŒºåŸŸå˜åŒ–
        if (lastRegion && currentRegion !== lastRegion && currentRegion !== 'outside') {
          // æ£€æŸ¥æ˜¯å¦æ˜¯å›è§†ï¼ˆå¿«é€Ÿå›åˆ°ä¹‹å‰çš„åŒºåŸŸï¼‰
          if (lastTransitionTime && (gaze.timestamp - lastTransitionTime) < 500) {
            regressions++;
          }
          lastTransitionTime = gaze.timestamp;
        }

        lastRegion = currentRegion;
      });

      // æ ¹æ®å›¾ç‰‡ç±»å‹å’Œå±æ€§è®¡ç®—æœ€ç»ˆæŒ‡æ ‡
      let result = {};

      if (imageType === 'food') {
        // é£Ÿç‰©å›¾ç‰‡ï¼šå‰8å¼ æ˜¯ä½çƒ­é‡åœ¨å·¦è¾¹ï¼Œå12å¼ æ˜¯é«˜çƒ­é‡åœ¨å·¦è¾¹
        const isLowCalorieLeft = parseInt(imageAttribute.split('_')[0]) <= 8;

        if (isLowCalorieLeft) {
          // å·¦è¾¹æ˜¯ä½çƒ­é‡ï¼Œå³è¾¹æ˜¯é«˜çƒ­é‡
          result.dwellTime = rightDwellTime - leftDwellTime; // é«˜çƒ­é‡-ä½çƒ­é‡
          result.firstFixation = firstFixation === 'right' ? 1 : (firstFixation === 'left' ? -1 : 0);
        } else {
          // å·¦è¾¹æ˜¯é«˜çƒ­é‡ï¼Œå³è¾¹æ˜¯ä½çƒ­é‡
          result.dwellTime = leftDwellTime - rightDwellTime; // é«˜çƒ­é‡-ä½çƒ­é‡
          result.firstFixation = firstFixation === 'left' ? 1 : (firstFixation === 'right' ? -1 : 0);
        }
      } else if (imageType === 'body') {
        // èº«æå›¾ç‰‡ï¼šå‰11å¼ æ˜¯èƒ–å­åœ¨å·¦è¾¹ï¼Œå14å¼ æ˜¯ç˜¦å­åœ¨å·¦è¾¹
        const isFatLeft = parseInt(imageAttribute.split('_')[0]) <= 11;

        if (isFatLeft) {
          // å·¦è¾¹æ˜¯èƒ–å­ï¼Œå³è¾¹æ˜¯ç˜¦å­
          result.dwellTime = leftDwellTime - rightDwellTime; // èƒ–å­-ç˜¦å­
          result.firstFixation = firstFixation === 'left' ? 1 : (firstFixation === 'right' ? -1 : 0);
        } else {
          // å·¦è¾¹æ˜¯ç˜¦å­ï¼Œå³è¾¹æ˜¯èƒ–å­
          result.dwellTime = rightDwellTime - leftDwellTime; // èƒ–å­-ç˜¦å­
          result.firstFixation = firstFixation === 'right' ? 1 : (firstFixation === 'left' ? -1 : 0);
        }
      }

      result.regressionCount = regressions;
      result.leftDwellTime = leftDwellTime;
      result.rightDwellTime = rightDwellTime;

      // æ›´æ–°è°ƒè¯•ä¿¡æ¯
      updateDebugInfo(
        `${imageType}-${imageAttribute}`,
        gazeData.length,
        leftDwellTime,
        rightDwellTime,
        firstFixation,
        regressions
      );

      return result;
    }

  // ä¿®æ”¹æ±‡æ€»åˆ†æç»“æœçš„å‡½æ•°
function aggregateResults(trialData) {
    const foodTrials = trialData.filter(trial => trial.image_type === 'food');
    const bodyTrials = trialData.filter(trial => trial.image_type === 'body');

    // è®¡ç®—é£Ÿç‰©å›¾ç‰‡çš„å¹³å‡å€¼
    if (foodTrials.length > 0) {
        analysisResults.food.dwellTime = foodTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.dwellTime) || 0), 0) / foodTrials.length;
        analysisResults.food.firstFixation = foodTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.firstFixation) || 0), 0);
        analysisResults.food.regressionCount = foodTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.regressionCount) || 0), 0) / foodTrials.length;
    }

    // è®¡ç®—èº«æå›¾ç‰‡çš„å¹³å‡å€¼
    if (bodyTrials.length > 0) {
        analysisResults.body.dwellTime = bodyTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.dwellTime) || 0), 0) / bodyTrials.length;
        analysisResults.body.firstFixation = bodyTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.firstFixation) || 0), 0);
        analysisResults.body.regressionCount = bodyTrials.reduce((sum, trial) =>
            sum + ((trial.analysisResult && trial.analysisResult.regressionCount) || 0), 0) / bodyTrials.length;
    }

    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    console.log('åˆ†æç»“æœæ±‡æ€»:', analysisResults);
    console.log('ç‰¹å¾å€¼å¯¹åº”:');
    console.log('bé¦–è§†ç‚¹ (body.firstFixation):', analysisResults.body.firstFixation);
    console.log('bå›è§†æ¬¡æ•° (body.regressionCount):', analysisResults.body.regressionCount);
    console.log('bæ³¨è§†æ—¶é•¿ (body.dwellTime):', analysisResults.body.dwellTime);
    console.log('fé¦–è§†ç‚¹ (food.firstFixation):', analysisResults.food.firstFixation);
    console.log('få›è§†æ¬¡æ•° (food.regressionCount):', analysisResults.food.regressionCount);
    console.log('fæ³¨è§†æ—¶é•¿ (food.dwellTime):', analysisResults.food.dwellTime);
}

  // ç”Ÿæˆç»“æœè¡¨æ ¼
function generateResultsTable(predictionResult = null) {
    let tableContent = `
        <table class="results-table">
            <thead>
                <tr>
                    <th>è¢«è¯•ç¼–å·</th>
                    <th>Fæ³¨è§†æ—¶é—´(ms)</th>
                    <th>Bæ³¨è§†æ—¶é—´(ms)</th>
                    <th>Fé¦–è§†ç‚¹</th>
                    <th>Bé¦–è§†ç‚¹</th>
                    <th>Få›è§†æ¬¡æ•°</th>
                    <th>Bå›è§†æ¬¡æ•°</th>
    `;

    // æ·»åŠ é¢„æµ‹ç»“æœåˆ—
    if (predictionResult) {
        tableContent += `
                    <th>é¢„æµ‹ç»“æœ</th>
        `;
    }

    tableContent += `
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${userInfo.subjectId}</td>
                    <td>${analysisResults.food.dwellTime.toFixed(2)}</td>
                    <td>${analysisResults.body.dwellTime.toFixed(2)}</td>
                    <td>${analysisResults.food.firstFixation}</td>
                    <td>${analysisResults.body.firstFixation}</td>
                    <td>${analysisResults.food.regressionCount.toFixed(2)}</td>
                    <td>${analysisResults.body.regressionCount.toFixed(2)}</td>
    `;

    // æ·»åŠ é¢„æµ‹ç»“æœæ•°æ®
    if (predictionResult) {
        const resultText = predictionResult.predictedClass === 1 ? 'ä¸æ­£å¸¸' : 'æ­£å¸¸';
        tableContent += `
                    <td>${resultText}</td>
        `;
    }

    tableContent += `
                </tr>
            </tbody>
        </table>
    `;

    return tableContent;
}
// ç”ŸæˆCSVæ ¼å¼çš„ç»“æœ
function generateResultsCSV(predictionResult = null) {
  let csvHeader = 'è¢«è¯•ç¼–å·,Fæ³¨è§†æ—¶é—´(ms),Bæ³¨è§†æ—¶é—´(ms),Fé¦–è§†ç‚¹,Bé¦–è§†ç‚¹,Få›è§†æ¬¡æ•°,Bå›è§†æ¬¡æ•°';
  let csvData = `${userInfo.subjectId},${analysisResults.food.dwellTime.toFixed(2)},${analysisResults.body.dwellTime.toFixed(2)},${analysisResults.food.firstFixation},${analysisResults.body.firstFixation},${analysisResults.food.regressionCount.toFixed(2)},${analysisResults.body.regressionCount.toFixed(2)}`;

  // å¦‚æœæœ‰é¢„æµ‹ç»“æœï¼Œåªæ·»åŠ é¢„æµ‹ç»“æœï¼Œåˆ é™¤ç½®ä¿¡åº¦å’Œé£é™©ç­‰çº§
  if (predictionResult) {
    const resultText = predictionResult.predictedClass === 1 ? 'ä¸æ­£å¸¸' : 'æ­£å¸¸';
    csvHeader += ',é¢„æµ‹ç»“æœ';
    csvData += `,${resultText}`;
  }

  return `${csvHeader}\n${csvData}`;
}

/* ==== ONNXæ¨¡å‹åŠŸèƒ½ ==== */
async function loadModel() {
    try {
        console.log('å¼€å§‹åŠ è½½æ¨¡å‹...');

        // åŠ è½½é¢„å¤„ç†é…ç½®
        const configResponse = await fetch('preprocessing.json');
        if (!configResponse.ok) {
            throw new Error(`é¢„å¤„ç†é…ç½®åŠ è½½å¤±è´¥: ${configResponse.status}`);
        }
        preprocessingConfig = await configResponse.json();
        console.log('é¢„å¤„ç†é…ç½®åŠ è½½æˆåŠŸ:', preprocessingConfig);

        // åŠ è½½ONNXæ¨¡å‹
        onnxSession = await ort.InferenceSession.create('model.onnx');
        console.log('ONNXæ¨¡å‹åŠ è½½æˆåŠŸ');

        modelLoaded = true;
        return true;
    } catch (error) {
        console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
        modelLoaded = false;
        return false;
    }
}

// ç‰¹å¾æ˜ å°„å‡½æ•° - å°†HTMLæ•°æ®è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥
function prepareModelInput(analysisResults) {
    // æ ¹æ®é¢„å¤„ç†é…ç½®ä¸­çš„ç‰¹å¾é¡ºåºå‡†å¤‡è¾“å…¥
    const featureValues = [];

    // ç‰¹å¾é¡ºåº: ['bé¦–è§†ç‚¹', 'bå›è§†æ¬¡æ•°', 'bæ³¨è§†æ—¶é•¿', 'fé¦–è§†ç‚¹', 'få›è§†æ¬¡æ•°', 'fæ³¨è§†æ—¶é•¿']
    featureValues.push(analysisResults.body.firstFixation);    // bé¦–è§†ç‚¹
    featureValues.push(analysisResults.body.regressionCount);  // bå›è§†æ¬¡æ•°
    featureValues.push(analysisResults.body.dwellTime);        // bæ³¨è§†æ—¶é•¿
    featureValues.push(analysisResults.food.firstFixation);    // fé¦–è§†ç‚¹
    featureValues.push(analysisResults.food.regressionCount);  // få›è§†æ¬¡æ•°
    featureValues.push(analysisResults.food.dwellTime);        // fæ³¨è§†æ—¶é•¿

    console.log('åŸå§‹ç‰¹å¾å€¼:', featureValues);

    // æ ‡å‡†åŒ–å¤„ç†
    const standardizedFeatures = featureValues.map((value, index) => {
        const mean = preprocessingConfig.mean[index];
        const scale = preprocessingConfig.scale[index];
        return (value - mean) / scale;
    });

    console.log('æ ‡å‡†åŒ–åç‰¹å¾å€¼:', standardizedFeatures);

    return standardizedFeatures;
}

// ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹
async function predictEatingDisorder(analysisResults) {
    if (!modelLoaded || !onnxSession) {
        console.error('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•è¿›è¡Œé¢„æµ‹');
        return {
            predictedClass: -1,
            confidence: 0,
            riskLevel: 'æœªçŸ¥',
            error: 'æ¨¡å‹æœªåŠ è½½'
        };
    }

    try {
        // å‡†å¤‡è¾“å…¥æ•°æ®
        const inputData = prepareModelInput(analysisResults);

        // åˆ›å»ºONNXè¾“å…¥å¼ é‡
        const inputTensor = new ort.Tensor('float32', Float32Array.from(inputData), [1, 6]);

        // è¿è¡Œé¢„æµ‹
        const results = await onnxSession.run({ 'float_input': inputTensor });

        // è·å–é¢„æµ‹ç»“æœ
        const output = results.output.data;
        console.log('æ¨¡å‹è¾“å‡º:', output);

        // è§£æé¢„æµ‹ç»“æœ
        return {
            probabilities: Array.from(output),
            predictedClass: output[1] > 0.5 ? 1 : 0,
            confidence: Math.max(...output) * 100,
            riskLevel: output[1] > 0.7 ? 'é«˜é£é™©' : output[1] > 0.4 ? 'ä¸­ç­‰é£é™©' : 'ä½é£é™©'
        };

    } catch (error) {
        console.error('é¢„æµ‹å¤±è´¥:', error);
        return {
            predictedClass: -1,
            confidence: 0,
            riskLevel: 'æœªçŸ¥',
            error: error.message
        };
    }
}
    /* ==== GitHub API åŠŸèƒ½ ==== */

    // åˆ›å»ºæˆ–è·å–Issueï¼ˆå¸¦é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ï¼‰ - æ€»å…±å°è¯•2æ¬¡
    async function getOrCreateIssue(retries = 1) {
      const issueTitle = `${userInfo.subjectId}`;

      try {
        // ä½¿ç”¨AbortControllerå®ç°è¶…æ—¶
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_issue',
            subjectId: userInfo.subjectId,
            gender: userInfo.gender,
            age: userInfo.age
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('GitHub APIé”™è¯¯è¯¦æƒ…:', errorData);
          let errorMsg = `ä¸­è½¬APIè¿”å›é”™è¯¯: ${response.status}`;
          if (errorData && errorData.error) {
            errorMsg = errorData.error;
            if (errorData.message) {
              errorMsg += `: ${errorData.message}`;
            }
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`GitHub Issueæ“ä½œå¤±è´¥(å‰©ä½™é‡è¯•æ¬¡æ•°: ${retries-1}):`, error);

        // å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œç­‰å¾…åé‡è¯•
        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return getOrCreateIssue(retries - 1);
        }

        throw error;
      }
    }

    // æ·»åŠ å•æ¡Issueè¯„è®º - ä¿®æ”¹ï¼šé‡è¯•æ¬¡æ•°æ”¹ä¸º1ï¼ˆå³æ€»å…±å°è¯•2æ¬¡ï¼‰
    async function addIssueComment(issueNumber, commentBody, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'add_comment',
            issueNumber: issueNumber,
            commentBody: commentBody
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          console.error('æ·»åŠ è¯„è®ºé”™è¯¯è¯¦æƒ…:', errorData);
          let errorMsg = `ä¸­è½¬APIè¿”å›é”™è¯¯: ${response.status}`;
          if (errorData && errorData.error) {
            errorMsg = errorData.error;
            if (errorData.message) {
              errorMsg += `: ${errorData.message}`;
            }
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`æ·»åŠ è¯„è®ºå¤±è´¥(å‰©ä½™é‡è¯•æ¬¡æ•°: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return addIssueComment(issueNumber, commentBody, retries - 1);
        }

        throw error;
      }
    }

    // ä¸Šä¼ æ–‡ä»¶åˆ°GitHubä»“åº“ï¼ˆæ”¯æŒåˆ†å—ä¸Šä¼ ï¼‰
    async function uploadFileToGitHub(content, fileName, directory, retries = 1) {
      const MAX_FILE_SIZE = 700 * 1024; // 700KB
      const encoder = new TextEncoder();
      const fileData = encoder.encode(content);
      const totalSize = fileData.length;

      try {
        // è§£ææ–‡ä»¶åå’Œåç¼€
        const lastDotIndex = fileName.lastIndexOf('.');
        let baseName, extension;
        if (lastDotIndex === -1) {
          baseName = fileName;
          extension = '';
        } else {
          baseName = fileName.substring(0, lastDotIndex);
          extension = fileName.substring(lastDotIndex + 1);
        }

        // å¦‚æœæ–‡ä»¶å°äºæœ€å¤§é™åˆ¶ï¼Œç›´æ¥ä¸Šä¼ 
        if (totalSize <= MAX_FILE_SIZE) {
          return await uploadFilePart(content, `${directory}/${fileName}`, retries);
        }

        // åˆ†å‰²æ–‡ä»¶
        let uploadPromises = [];
        let partIndex = 1;
        let startIndex = 0;

        while (startIndex < totalSize) {
          // è®¡ç®—ç»“æŸä½ç½®ï¼ˆå°è¯•åœ¨æ¢è¡Œç¬¦å¤„åˆ†å‰²ï¼‰
          let endIndex = Math.min(startIndex + MAX_FILE_SIZE, totalSize);

          // æŸ¥æ‰¾æœ€è¿‘çš„æ¢è¡Œç¬¦
          while (endIndex < totalSize && fileData[endIndex] !== 10) { // 10æ˜¯æ¢è¡Œç¬¦çš„ASCII
            endIndex++;
          }

          // å¦‚æœæ‰¾ä¸åˆ°æ¢è¡Œç¬¦ï¼Œä½¿ç”¨æœ€å¤§ä½ç½®
          if (endIndex >= totalSize) {
            endIndex = totalSize;
          }

          // æå–å½“å‰éƒ¨åˆ†
          const partData = fileData.slice(startIndex, endIndex);
          const partContent = new TextDecoder().decode(partData);

          // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ·»åŠ åˆ†å—ç¼–å·ï¼‰
          const newFileName = extension ? `${baseName}_part${partIndex}.${extension}` : `${baseName}_part${partIndex}`;
          const partFileName = `${directory}/${newFileName}`;

          // ä¸Šä¼ åˆ†å—
          uploadPromises.push(uploadFilePart(partContent, partFileName, retries));

          // ç§»åŠ¨åˆ°ä¸‹ä¸€éƒ¨åˆ†
          startIndex = endIndex;
          partIndex++;
        }

        // ç­‰å¾…æ‰€æœ‰ä¸Šä¼ å®Œæˆ
        return await Promise.all(uploadPromises);
      } catch (error) {
        console.error(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥(å‰©ä½™é‡è¯•æ¬¡æ•°: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadFileToGitHub(content, fileName, directory, retries - 1);
        }

        throw error;
      }
    }

    // ä¸Šä¼ å•ä¸ªæ–‡ä»¶åˆ†å—åˆ°GitHub - æ€»å…±å°è¯•2æ¬¡
    async function uploadFilePart(content, fileName, retries = 1) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // å»¶é•¿è¶…æ—¶æ—¶é—´åˆ°20ç§’

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'upload_file',
            fileName: fileName,
            content: content,
            directory: fileName.includes('/') ? fileName.substring(0, fileName.lastIndexOf('/')) : ''
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
          let errorMsg = `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData && errorData.error) {
              errorMsg = errorData.error;
              if (errorData.message) {
                errorMsg += `: ${errorData.message}`;
              }
            }
          } catch (e) {
            // å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸé”™è¯¯ä¿¡æ¯
            console.error('è§£æé”™è¯¯å“åº”å¤±è´¥', e);
            errorMsg = `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`;
          }
          throw new Error(errorMsg);
        }

        return await response.json();
      } catch (error) {
        console.error(`æ–‡ä»¶åˆ†å—ä¸Šä¼ å¤±è´¥(å‰©ä½™é‡è¯•æ¬¡æ•°: ${retries-1}):`, error);

        if (retries > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return uploadFilePart(content, fileName, retries - 1);
        }

        throw error;
      }
    }

    // ç”ŸæˆGitHubè¯„è®ºå†…å®¹ï¼ˆåŒ…å«åˆ†æç»“æœå’Œé¢„æµ‹ï¼‰
function generateGitHubComment(dataPoints, predictionResult = null) {
    const now = new Date();
    const dateTime = `${now.getFullYear()}å¹´${(now.getMonth()+1).toString().padStart(2, '0')}æœˆ${now.getDate().toString().padStart(2, '0')}æ—¥ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

    let comment = `## ç¬¬ ${userInfo.session} æ¬¡å®éªŒæ•°æ®\n\n` +
           `- **å®éªŒæ—¥æœŸæ—¶é—´**: ${dateTime}\n` +
           `- **çœ¼åŠ¨æ•°æ®ç‚¹æ€»æ•°**: ${dataPoints}\n` +
           `- **Fæ³¨è§†æ—¶é—´**: ${analysisResults.food.dwellTime.toFixed(2)}ms\n` +
           `- **Bæ³¨è§†æ—¶é—´**: ${analysisResults.body.dwellTime.toFixed(2)}ms\n` +
           `- **Fé¦–è§†ç‚¹**: ${analysisResults.food.firstFixation}\n` +
           `- **Bé¦–è§†ç‚¹**: ${analysisResults.body.firstFixation}\n` +
           `- **Få›è§†æ¬¡æ•°**: ${analysisResults.food.regressionCount.toFixed(2)}\n` +
           `- **Bå›è§†æ¬¡æ•°**: ${analysisResults.body.regressionCount.toFixed(2)}\n`;

    // æ·»åŠ é¢„æµ‹ç»“æœ
    if (predictionResult) {
        const resultText = predictionResult.predictedClass === 1 ? 'ä¸æ­£å¸¸' : 'æ­£å¸¸';
        comment += `- **AIé¢„æµ‹ç»“æœ**: ${resultText}\n`;
    }

    return comment;
}

    // ä¿å­˜CSVåˆ°æœ¬åœ°
    function saveCSVToLocal(csvContent, fileName) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // ä¿å­˜JSONåˆ°æœ¬åœ°
    function saveJSONToLocal(jsonContent, fileName) {
      const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    /* ç”Ÿæˆå›¾ç‰‡åˆ—è¡¨ */
    // é£Ÿç‰©å›¾ç‰‡ï¼šfæ–‡ä»¶å¤¹ï¼ˆå…±20å¼ ï¼‰
    // å‰8å¼ ï¼šå·¦ä¾§ä½çƒ­é‡ï¼›å12å¼ ï¼šå·¦ä¾§é«˜çƒ­é‡
    const foodImages = [];
    const totalFood = 20;
    const lowCalorieCount = 8; // å‰8å¼ ä¸ºå·¦ä¾§ä½çƒ­é‡
    for (let i = 1; i <= totalFood; i++) {
      const isLowCalorie = i <= lowCalorieCount;
      foodImages.push({
        src: `f/${i}.jpg`, // å›¾ç‰‡è·¯å¾„ï¼šfæ–‡ä»¶å¤¹ä¸‹
        type: 'food',
        attribute: `${i}_${isLowCalorie ? 'low_calorie' : 'high_calorie'}`, // æ ‡è®°é«˜ä½çƒ­é‡å’Œåºå·
        position: 'left', // å·¦ä¾§ä¸ºç›®æ ‡å±æ€§ï¼ˆä½/é«˜çƒ­é‡ï¼‰
        index: i // åŸå§‹åºå·
      });
    }

    // èº«æå›¾ç‰‡ï¼šbæ–‡ä»¶å¤¹ï¼ˆå…±25å¼ ï¼‰
    // å‰11å¼ ï¼šå·¦ä¾§èƒ–ï¼›å14å¼ ï¼šå·¦ä¾§ç˜¦
    const bodyImages = [];
    const totalBody = 25;
    const fatCount = 11; // å‰11å¼ ä¸ºå·¦ä¾§èƒ–
    for (let i = 1; i <= totalBody; i++) {
      const isFat = i <= fatCount;
      bodyImages.push({
        src: `b/${i}.jpg`, // å›¾ç‰‡è·¯å¾„ï¼šbæ–‡ä»¶å¤¹ä¸‹
        type: 'body',
        attribute: `${i}_${isFat ? 'fat' : 'thin'}`, // æ ‡è®°èƒ–/ç˜¦å’Œåºå·
        position: 'left', // å·¦ä¾§ä¸ºç›®æ ‡å±æ€§ï¼ˆèƒ–/ç˜¦ï¼‰
        index: i // åŸå§‹åºå·
      });
    }

    /* ==== ç”¨æˆ·ç™»å½•é¡µé¢ ==== */
    const loginScreen = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        // è·å–å½“å‰è¢«è¯•çš„æ¬¡æ•°ä¿¡æ¯
        let sessionInfo = "";
        const subjectIdEl = document.getElementById('subject-id');
        if (subjectIdEl && subjectIdEl.value) {
          const subjectId = subjectIdEl.value;
          const storedSession = localStorage.getItem(`session_${subjectId}`);
          const currentSession = storedSession ? parseInt(storedSession) + 1 : 1;
          sessionInfo = `<div class="session-display">è¿™æ˜¯æ‚¨çš„ç¬¬ <span>${currentSession}</span> æ¬¡å®éªŒ</div>`;
        }

        return `
          <div class="login-container">
            <h2>å®éªŒç”¨æˆ·ç™»å½•</h2>
            <div class="form-group">
              <label for="subject-id">è¢«è¯•ID</label>
              <select id="subject-id">
                <option value="">è¯·é€‰æ‹©è¢«è¯•ID</option>
                ${Array.from({length: 151}, (_, i) => {
                  const id = `eye-${(i+1).toString().padStart(3, '0')}`;
                  return `<option value="${id}">${id}</option>`;
                }).join('')}
              </select>
            </div>
            ${sessionInfo}
            <div class="form-group">
              <label for="gender">æ€§åˆ«</label>
              <select id="gender">
                <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label for="age">å¹´é¾„</label>
              <input type="number" id="age" min="18" max="60" placeholder="è¯·è¾“å…¥å¹´é¾„">
            </div>
            <button class="login-button" id="login-btn">å¼€å§‹å®éªŒ</button>
            <div id="login-status" style="margin-top: 15px;"></div>
          </div>
        `;
      },
      choices: [],
      on_load: function() {
        // ç›‘å¬è¢«è¯•IDå˜åŒ–ï¼Œæ›´æ–°æ¬¡æ•°æ˜¾ç¤ºå¹¶è‡ªåŠ¨å¡«å……ç”¨æˆ·ä¿¡æ¯
        document.getElementById('subject-id').addEventListener('change', function() {
          const subjectId = this.value;
          if (subjectId) {
            const storedSession = localStorage.getItem(`session_${subjectId}`);
            const currentSession = storedSession ? parseInt(storedSession) + 1 : 1;

            // åˆ›å»ºæˆ–æ›´æ–°æ¬¡æ•°æ˜¾ç¤º
            let sessionDisplay = document.querySelector('.session-display');
            if (!sessionDisplay) {
              sessionDisplay = document.createElement('div');
              sessionDisplay.className = 'session-display';
              document.querySelector('.login-container').insertBefore(sessionDisplay, document.querySelector('.form-group:last-child'));
            }
            sessionDisplay.innerHTML = `è¿™æ˜¯æ‚¨çš„ç¬¬ <span>${currentSession}</span> æ¬¡å®éªŒ`;

            // å°è¯•è·å–å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯å¹¶è‡ªåŠ¨å¡«å……
            const userData = localStorage.getItem(`user_${subjectId}`);
            if (userData) {
              try {
                const { gender, age } = JSON.parse(userData);
                document.getElementById('gender').value = gender;
                document.getElementById('age').value = age;
              } catch (e) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥', e);
              }
            }
          }
        });

        document.getElementById('login-btn').addEventListener('click', function() {
          const subjectId = document.getElementById('subject-id').value;
          const gender = document.getElementById('gender').value;
          const age = document.getElementById('age').value;
          const statusEl = document.getElementById('login-status');

          if (!subjectId) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">è¯·é€‰æ‹©è¢«è¯•ID</p>';
            return;
          }
          if (!gender) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">è¯·é€‰æ‹©æ€§åˆ«</p>';
            return;
          }
          if (!age) {
            statusEl.innerHTML = '<p style="color: #e74c3c;">è¯·è¾“å…¥å¹´é¾„</p>';
            return;
          }

          // ä»localStorageè·å–å½“å‰æ¬¡æ•°
          const storedSession = localStorage.getItem(`session_${subjectId}`);
          const session = storedSession ? parseInt(storedSession) + 1 : 1;

          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          userInfo = {
            subjectId,
            session,
            gender,
            age: parseInt(age)
          };

          // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆæ€§åˆ«å’Œå¹´é¾„ï¼‰
          localStorage.setItem(`user_${subjectId}`, JSON.stringify({ gender, age }));

          // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
          statusEl.innerHTML = '<p style="color: #27ae60;">éªŒè¯é€šè¿‡ï¼Œæ­£åœ¨è¿›å…¥å®éªŒ...</p>';

          // ç»§ç»­å®éªŒæµç¨‹
          setTimeout(() => {
            jsPsych.finishTrial();
          }, 1000);
        });
      }
    };

    const timeline = [];
    timeline.push(loginScreen);

    // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        if (!userInfo) {
          return `
            <div class="centered-text">
              <p>æ¬¢è¿å‚ä¸å®éªŒ</p>
              <p>æŒ‰ä»»æ„é”®ç»§ç»­</p>
            </div>
          `;
        }
        return `
          <div class="centered-text">
            <p>æ¬¢è¿æ‚¨å‚ä¸ç¬¬ ${userInfo.session} æ¬¡å®éªŒ</p>
            <p>æŒ‰ä»»æ„é”®ç»§ç»­</p>
          </div>
        `;
      }
    });

    /* é¢„åŠ è½½èµ„æº */
    const allImages = [...foodImages, ...bodyImages].map(img => img.src);
    const preload = {
      type: jsPsychPreload,
      images: allImages,
      message: '<div class="centered-text><p>æ­£åœ¨åŠ è½½èµ„æºï¼Œè¯·ç¨å€™â€¦</p></div>',
      on_error: function(failed_resources) {
        const resources = Array.isArray(failed_resources) ? failed_resources : [failed_resources];
        const errorList = resources.map(r => `<p>â€¢ èµ„æºåŠ è½½å¤±è´¥: ${r.url || r}</p>`).join('');
        return `<div class="centered-text">
          <p style="color: #e74c3c; font-weight: bold;">èµ„æºåŠ è½½é”™è¯¯ï¼š</p>
          ${errorList}
          <p>è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºæ­£ç¡®è·¯å¾„</p>
        </div>`;
      }
    };
    timeline.push(preload);

    /* ==== æ ¡å‡†ç›¸å…³çš„å„ä¸ªæ­¥éª¤ ==== */
    const camera_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ä¸ºäº†è¿›è¡Œçœ¼åŠ¨è¿½è¸ªï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®æ‚¨çš„æ‘„åƒå¤´ã€‚</p>
          <p>æ‚¨å°†åœ¨ä¸‹ä¸€å±å¹•æ”¶åˆ°æƒé™è¯·æ±‚ã€‚</p>
          <p class="warning">è¯·åŠ¡å¿…ç‚¹å‡»"å…è®¸"ï¼Œå¦åˆ™çœ¼åŠ¨è¿½è¸ªåŠŸèƒ½å°†æ— æ³•å·¥ä½œã€‚</p>
          <p>æ‘„åƒå¤´ä»…ç”¨äºåˆ†ææ‚¨çš„çœ¼éƒ¨è¿åŠ¨ï¼Œä¸ä¼šä¿å­˜ä»»ä½•è§†é¢‘æ•°æ®ã€‚</p>
        </div>
      `,
      choices: ['æ˜ç™½äº†'],
      on_load: async function() {
        // æå‰æ£€æµ‹æƒé™
        const cameraStatus = await checkCameraPermission();

        // å¦‚æœæƒé™æœ‰é—®é¢˜ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
        if (!cameraStatus.hasPermission || !cameraStatus.isSecure || !cameraStatus.hasMediaDevices) {
          showPermissionError(cameraStatus);

          // ä¿å­˜ç»§ç»­å®éªŒçš„å‡½æ•°
          window.resumeExperiment = () => {
            jsPsych.finishTrial();
          };

          // æš‚åœå®éªŒç›´åˆ°ç”¨æˆ·æ“ä½œ
          return false;
        }
      }
    };
    timeline.push(camera_instructions);

    // åˆå§‹åŒ–æ‘„åƒå¤´ï¼ˆæ˜¾ç¤ºç”»é¢ï¼‰
    const init_camera = {
      type: jsPsychWebgazerInitCamera,
      on_error: function() {
        cameraPermissionDenied = true;
        updateInitStatus('webgazer', 'åˆå§‹åŒ–å¤±è´¥', true);
      },
      on_load: function() {
        updateInitStatus('webgazer', 'åˆå§‹åŒ–ä¸­...');
      },
      on_finish: function() {
        if (!cameraPermissionDenied) {
          updateInitStatus('webgazer', 'å·²åˆå§‹åŒ–');
          webgazerInitialized = true;

          // æ·»åŠ äººè„¸æ£€æµ‹
          setTimeout(async () => {
            const faceDetected = await checkFaceDetection();
            if (!faceDetected) {
              showFaceDetectionHelp();

              // æš‚åœå®éªŒç›´åˆ°ç”¨æˆ·æ“ä½œ
              return false;
            }
          }, 1000);
        }
      }
    };
    timeline.push(init_camera);

    // æ·»åŠ æƒé™æ£€æŸ¥ç‚¹
    timeline.push({
      type: jsPsychHtmlButtonResponse,
      stimulus: '',
      choices: [],
      trial_duration: 100,
      on_load: function() {
        // å¦‚æœæƒé™è¢«æ‹’ç»ï¼Œè·³è¿‡çœ¼åŠ¨ç›¸å…³æ­¥éª¤
        if (cameraPermissionDenied) {
          // ç›´æ¥è·³è½¬åˆ°å®éªŒè¯´æ˜
          jsPsych.endCurrentTimeline();

          // æ˜¾ç¤ºè­¦å‘Š
          const warningHTML = `
            <div class="centered-text">
              <p class="warning">è­¦å‘Šï¼šæ‘„åƒå¤´æƒé™æœªæˆäºˆ</p>
              <p>çœ¼åŠ¨è¿½è¸ªåŠŸèƒ½å·²è¢«ç¦ç”¨ï¼Œå®éªŒå°†ç»§ç»­è¿›è¡Œä½†ä¸ä¼šè®°å½•çœ¼åŠ¨æ•°æ®ã€‚</p>
              <p>æŒ‰ä»»æ„é”®ç»§ç»­å®éªŒã€‚</p>
            </div>
          `;

          const warningTrial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: warningHTML
          };

          jsPsych.addNodeToEndOfTimeline(warningTrial);
        }
      }
    });

    const calibration_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ç°åœ¨å°†è¿›è¡Œçœ¼åŠ¨æ ¡å‡†ï¼Œä»¥ä¾¿è½¯ä»¶ä½¿ç”¨æ‚¨çš„çœ¼éƒ¨å›¾åƒé¢„æµ‹æ‚¨çš„æ³¨è§†ä½ç½®ã€‚</p>
          <p>æ‚¨å°†çœ‹åˆ°ä¸€ç³»åˆ—åœ†ç‚¹å‡ºç°åœ¨å±å¹•ä¸Šã€‚è¯·æ³¨è§†æ¯ä¸ªåœ†ç‚¹å¹¶ç‚¹å‡»å®ƒã€‚</p>
          <p style="color: red; font-weight: bold;">è¯·ç¡®ä¿ï¼š</p>
          <ul style="text-align: left; max-width: 600px; margin: 0 auto;">
            <li>æ‚¨çš„è„¸éƒ¨åœ¨æ‘„åƒå¤´ç”»é¢ä¸­</li>
            <li>å…‰çº¿å……è¶³ï¼Œä¸è¦è¿‡æš—æˆ–è¿‡äº®</li>
            <li>é¿å…æ™ƒåŠ¨å¤´éƒ¨</li>
          </ul>
        </div>
      `,
      choices: ['æ˜ç™½äº†']
    };
    timeline.push(calibration_instructions);

    const calibration = {
      type: jsPsychWebgazerCalibrate,
      calibration_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      repetitions_per_point: 2,
      randomize_calibration_order: true
    };
    timeline.push(calibration);

    const validation_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ç°åœ¨æˆ‘ä»¬å°†æµ‹é‡æ ¡å‡†çš„å‡†ç¡®æ€§ã€‚</p>
          <p>è¯·æ³¨è§†å±å¹•ä¸Šå‡ºç°çš„æ¯ä¸ªåœ†ç‚¹ã€‚</p>
          <p style="font-weight: bold;">è¿™æ¬¡æ‚¨ä¸éœ€è¦ç‚¹å‡»åœ†ç‚¹ã€‚</p>
        </div>
      `,
      choices: ['æ˜ç™½äº†'],
      post_trial_gap: 1000
    };
    timeline.push(validation_instructions);

    const validation = {
      type: jsPsychWebgazerValidate,
      validation_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      roi_radius: 200,
      time_to_saccade: 1000,
      validation_duration: 2000,
      data: { task: 'validate' }
    };
    timeline.push(validation);

    const recalibrate_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>æ ¡å‡†çš„å‡†ç¡®æ€§ä½äºé¢„æœŸæ°´å¹³ã€‚</p>
          <p>è®©æˆ‘ä»¬å†å°è¯•æ ¡å‡†ä¸€æ¬¡ã€‚</p>
          <p>åœ¨ä¸‹ä¸€å±å¹•ï¼Œè¯·æ³¨è§†åœ†ç‚¹å¹¶ç‚¹å‡»å®ƒä»¬ã€‚</p>
        </div>
      `,
      choices: ['å¥½çš„']
    };
    const recalibrate = {
      timeline: [recalibrate_instructions, calibration, validation_instructions, validation],
      conditional_function: function() {
        const val_data = jsPsych.data.get().filter({ task: 'validate' }).values()[0];
        return val_data && val_data.percent_in_roi && val_data.percent_in_roi.some(x => x < 50);
      },
      data: { phase: 'recalibration' }
    };
    timeline.push(recalibrate);

    const calibration_done = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>å¤ªå¥½äº†ï¼Œæ ¡å‡†å·²å®Œæˆï¼</p>
          <p>æ¥ä¸‹æ¥å°†å¼€å§‹å®éªŒï¼Œè¯·æ³¨è§†å±å¹•ä¸­å¤®çš„åå­—ï¼Œç„¶åè§‚çœ‹å›¾ç‰‡ã€‚</p>
        </div>
      `,
      choices: ['ç»§ç»­']
    };
    timeline.push(calibration_done);

    /* ==== æ¬¢è¿é¡µ å’Œ å®éªŒè¯´æ˜ ==== */
    const welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="centered-text">
          <p>æ¬¢è¿å‚åŠ è¿›é£Ÿéšœç¢çœ¼åŠ¨ç¨‹åºã€‚æŒ‰ä»»æ„é”®ç»§ç»­ã€‚</p>
        </div>
      `
    };
    timeline.push(welcome);

    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="centered-text">
          <p>åœ¨å®éªŒä¸­ï¼Œæ‚¨å°†å…ˆåè§‚çœ‹ä¸¤ç±»å¯¹æ¯”å›¾ç‰‡ï¼šé£Ÿç‰©å›¾ç‰‡å’Œèº«æå›¾ç‰‡ã€‚</p>
          <p>é£Ÿç‰©å›¾ç‰‡å±•ç¤ºå·¦ä¾§ä½çƒ­é‡/é«˜çƒ­é‡é£Ÿç‰©çš„å¯¹æ¯”ï¼Œèº«æå›¾ç‰‡å±•ç¤ºå·¦ä¾§èƒ–/ç˜¦èº«æçš„å¯¹æ¯”ã€‚</p>
          <p>æ¯å¼ å›¾ç‰‡å°†å‘ˆç°6ç§’ï¼Œå›¾ç‰‡ä¹‹é—´ä¼‘æ¯2ç§’ã€‚</p>
          <p>è¯·æŒ‰ä»»æ„é”®å¼€å§‹å®éªŒã€‚</p>
        </div>
      `,
      post_trial_gap: 2000
    };
    timeline.push(instructions);

    /* ==== æ„å»ºå®éªŒè¯•æ¬¡ ==== */
    // 1. é£Ÿç‰©å›¾ç‰‡è¯•æ¬¡ï¼ˆéšæœºå‘ˆç°æ‰€æœ‰é£Ÿç‰©å›¾ç‰‡ï¼‰
    const shuffledFoodImages = jsPsych.randomization.shuffle(foodImages); // éšæœºæ’åº
    const foodTrials = [];

    // 2. èº«æå›¾ç‰‡è¯•æ¬¡ï¼ˆéšæœºå‘ˆç°æ‰€æœ‰èº«æå›¾ç‰‡ï¼‰
    const shuffledBodyImages = jsPsych.randomization.shuffle(bodyImages); // éšæœºæ’åº
    const bodyTrials = [];

    const centralFixation = document.getElementById('central-fixation');
    const gazePoint = document.getElementById('gaze-point');

    // å¼€å§‹çœ¼åŠ¨è¿½è¸ªå¹¶è®°å½•æ•°æ®
    function startGazeTracking(trialData) {
      if (gazeUpdateInterval) clearInterval(gazeUpdateInterval);
      gazeData = []; // é‡ç½®çœ¼åŠ¨æ•°æ®æ•°ç»„

      // æ¯20msè®°å½•ä¸€æ¬¡çœ¼åŠ¨æ•°æ®ï¼ˆ50Hzé‡‡æ ·ç‡ï¼‰
      gazeUpdateInterval = setInterval(() => {
        if (webgazer) {
          webgazer.getCurrentPrediction().then(function(pred) {
            if (pred) {
              gazeData.push({
                timestamp: Date.now(),
                trial_start_time: trialData.trial_start_time,
                relative_time: Date.now() - trialData.trial_start_time,
                x: pred.x,
                y: pred.y,
                confidence: pred.confidence || null
              });
            }
          });
        }
      }, 20);
    }

    // åœæ­¢çœ¼åŠ¨è¿½è¸ªå¹¶ä¿å­˜æ•°æ®
    function stopGazeTracking() {
      if (gazeUpdateInterval) {
        clearInterval(gazeUpdateInterval);
        gazeUpdateInterval = null;
      }
      gazePoint.style.display = 'none';
      return gazeData; // è¿”å›æ”¶é›†çš„çœ¼åŠ¨æ•°æ®
    }

    // ç”Ÿæˆé£Ÿç‰©è¯•æ¬¡
    shuffledFoodImages.forEach((img, index) => {
      // æ³¨è§†ç‚¹è¯•æ¬¡
      foodTrials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: "NO_KEYS",
        trial_duration: jsPsych.randomization.sampleWithoutReplacement([800, 1000, 1200], 1)[0],
        data: {
          task: 'fixation',
          phase: 'food',
          block: 'food_presentation',
          trial_index: index + 1,
          total_trials: shuffledFoodImages.length
        },
        on_start: function() {
          centralFixation.style.display = 'block';
        },
        on_finish: function() {
          centralFixation.style.display = 'none';
        }
      });

      // å›¾ç‰‡å±•ç¤ºè¯•æ¬¡
      const foodTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          return `
            <div class="stimulus-container">
              <div class="left-region"></div>
              <div class="right-region"></div>
              <img src="${img.src}" class="stimulus-image" alt="é£Ÿç‰©å¯¹æ¯”å›¾ç‰‡" />
            </div>
          `;
        },
        trial_duration: 6000,
        choices: "NO_KEYS",
        data: {
          task: 'view',
          phase: 'food',
          block: 'food_presentation',
          image_type: img.type,
          image_attribute: img.attribute,
          image_position: img.position,
          original_index: img.index,
          image_src: img.src,
          trial_index: index + 1,
          total_trials: shuffledFoodImages.length,
          trial_start_time: null, // å°†åœ¨on_startä¸­è®¾ç½®
          gaze_data: null,
          analysisResult: null // å­˜å‚¨åˆ†æç»“æœ
        },
        extensions: [
          {
            type: jsPsychExtensionWebgazer,
            params: { targets: ['.stimulus-container'] }
          }
        ],
        on_start: function(trial) {
          // è®°å½•è¯•æ¬¡å¼€å§‹æ—¶é—´ - ä¿®å¤ç‚¹ï¼šç›´æ¥å­˜å‚¨åˆ°dataå¯¹è±¡
          const startTime = Date.now();
          trial.data.trial_start_time = startTime;
          // åœ¨è¯•æ¬¡å¯¹è±¡ä¸Šå­˜å‚¨å¼€å§‹æ—¶é—´
          this.trial_start_time = startTime;

          // åœ¨å›¾ç‰‡åŠ è½½å®Œæˆåè·å–å®¹å™¨ä½ç½®
          setTimeout(() => {
            const container = document.querySelector('.stimulus-container');
            if (container) {
              const rect = container.getBoundingClientRect();
              containerRect = {
                left: rect.left,
                right: rect.right,
                top: rect.top,
                bottom: rect.bottom
              };
              console.log('å®¹å™¨ä½ç½®ä¿¡æ¯:', containerRect);
            }
          }, 500);

          startGazeTracking(trial.data);
        },
        on_finish: function(data) {
          // ç¡®ä¿å¼€å§‹æ—¶é—´è¢«è®°å½•ï¼ˆä½¿ç”¨è¯•æ¬¡å¯¹è±¡ä¸Šå­˜å‚¨çš„å¼€å§‹æ—¶é—´ï¼‰
          data.trial_start_time = this.trial_start_time;

          // è®°å½•è¯•æ¬¡ç»“æŸæ—¶é—´å’Œçœ¼åŠ¨æ•°æ®
          const endTime = Date.now();
          data.trial_end_time = endTime;

          // ç¡®ä¿æœ‰æœ‰æ•ˆçš„å¼€å§‹æ—¶é—´
          const startTime = this.trial_start_time;
          if (startTime) {
            data.trial_duration_actual = endTime - startTime;
          } else {
            // å¦‚æœå¼€å§‹æ—¶é—´æ— æ•ˆï¼Œä½¿ç”¨çœ¼åŠ¨æ•°æ®çš„ç¬¬ä¸€æ¡æ—¶é—´æˆ³ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gazeData.length > 0) {
              data.trial_start_time = gazeData[0].timestamp;
              data.trial_duration_actual = endTime - data.trial_start_time;
            } else {
              // æ²¡æœ‰çœ¼åŠ¨æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤è¯•æ¬¡æ—¶é•¿
              data.trial_duration_actual = 6000;
            }
          }

          data.gaze_data = stopGazeTracking(); // ä¿å­˜çœ¼åŠ¨æ•°æ®

          // åˆ†æçœ¼åŠ¨æ•°æ®
           if (data.gaze_data && data.gaze_data.length > 0) {
    data.analysisResult = analyzeGazeData(data.gaze_data, data.image_type, data.image_attribute);
    console.log(`è¯•æ¬¡ ${data.trial_index} åˆ†æç»“æœ:`, data.analysisResult);
  } else {
    console.warn(`è¯•æ¬¡ ${data.trial_index} æ— çœ¼åŠ¨æ•°æ®`);
    // æ·»åŠ è¿™è¡Œä»£ç ï¼Œè®¾ç½®é»˜è®¤çš„analysisResultå¯¹è±¡
    data.analysisResult = {
      dwellTime: 0,
      firstFixation: 0,
      regressionCount: 0,
      leftDwellTime: 0,
      rightDwellTime: 0
    };
  }
}
      };
      foodTrials.push(foodTrial);

      // è¯•æ¬¡é—´ä¼‘æ¯ï¼ˆæœ€åä¸€ä¸ªè¯•æ¬¡åä¸ä¼‘æ¯ï¼‰
      if (index < shuffledFoodImages.length - 1) {
        foodTrials.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '',
          choices: "NO_KEYS",
          trial_duration: 2000,
          data: {
            task: 'rest',
            phase: 'food',
            block: 'food_presentation',
            trial_index: index + 1,
            total_trials: shuffledFoodImages.length
          }
        });
      }
    });

    // é˜¶æ®µè¿‡æ¸¡æç¤ºï¼ˆä»é£Ÿç‰©åˆ°èº«æï¼‰
    const phaseTransition = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>é£Ÿç‰©å›¾ç‰‡è§‚çœ‹å®Œæ¯•</p>
          <p>æ¥ä¸‹æ¥å°†å‘ˆç°èº«æå¯¹æ¯”å›¾ç‰‡</p>
        </div>
      `,
      choices: ['ç»§ç»­'],
      data: {
        task: 'transition',
        phase: 'between_blocks'
      }
    };

    /* ==== åœ¨é£Ÿç‰©å’Œèº«æå›¾ç‰‡ä¹‹é—´æ’å…¥ç¬¬äºŒä¸ªæ ¡å‡†ç¯èŠ‚ ==== */
    const second_calibration_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ç°åœ¨å°†è¿›è¡Œç¬¬äºŒæ¬¡çœ¼åŠ¨æ ¡å‡†ï¼Œä»¥ç¡®ä¿è¿½è¸ªå‡†ç¡®æ€§ã€‚</p>
          <p>æ‚¨å°†çœ‹åˆ°ä¸€ç³»åˆ—åœ†ç‚¹å‡ºç°åœ¨å±å¹•ä¸Šã€‚è¯·æ³¨è§†æ¯ä¸ªåœ†ç‚¹å¹¶ç‚¹å‡»å®ƒã€‚</p>
        </div>
      `,
      choices: ['æ˜ç™½äº†']
    };

    const second_calibration = {
      type: jsPsychWebgazerCalibrate,
      calibration_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      repetitions_per_point: 2,
      randomize_calibration_order: true
    };

    const second_validation_instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ç°åœ¨æˆ‘ä»¬å°†æµ‹é‡ç¬¬äºŒæ¬¡æ ¡å‡†çš„å‡†ç¡®æ€§ã€‚</p>
          <p>è¯·æ³¨è§†å±å¹•ä¸Šå‡ºç°çš„æ¯ä¸ªåœ†ç‚¹ã€‚</p>
          <p style="font-weight: bold;">è¿™æ¬¡æ‚¨ä¸éœ€è¦ç‚¹å‡»åœ†ç‚¹ã€‚</p>
        </div>
      `,
      choices: ['æ˜ç™½äº†'],
      post_trial_gap: 1000
    };

    const second_validation = {
      type: jsPsychWebgazerValidate,
      validation_points: [
        [25, 25], [75, 25], [50, 50], [25, 75], [75, 75]
      ],
      roi_radius: 200,
      time_to_saccade: 1000,
      validation_duration: 2000,
      data: { task: 'validate_second' }
    };

    const second_recalibrate = {
      timeline: [second_calibration_instructions, second_calibration, second_validation_instructions, second_validation],
      conditional_function: function() {
        const val_data = jsPsych.data.get().filter({ task: 'validate_second' }).values()[0];
        return val_data && val_data.percent_in_roi && val_data.percent_in_roi.some(x => x < 50);
      },
      data: { phase: 'second_recalibration' }
    };

    const second_calibration_done = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <div class="centered-text">
          <p>ç¬¬äºŒæ¬¡æ ¡å‡†å·²å®Œæˆï¼</p>
          <p>æ¥ä¸‹æ¥å°†å‘ˆç°èº«æå¯¹æ¯”å›¾ç‰‡ï¼Œè¯·æ³¨è§†å±å¹•ä¸­å¤®çš„åå­—ï¼Œç„¶åè§‚çœ‹å›¾ç‰‡ã€‚</p>
        </div>
      `,
      choices: ['ç»§ç»­']
    };

    // ç”Ÿæˆèº«æè¯•æ¬¡
    shuffledBodyImages.forEach((img, index) => {
      // æ³¨è§†ç‚¹è¯•æ¬¡
      bodyTrials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: "NO_KEYS",
        trial_duration: jsPsych.randomization.sampleWithoutReplacement([800, 1000, 1200], 1)[0],
        data: {
          task: 'fixation',
          phase: 'body',
          block: 'body_presentation',
          trial_index: index + 1,
          total_trials: shuffledBodyImages.length
        },
        on_start: function() {
          centralFixation.style.display = 'block';
        },
        on_finish: function() {
          centralFixation.style.display = 'none';
        }
      });

      // å›¾ç‰‡å±•ç¤ºè¯•æ¬¡
      const bodyTrial = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          return `
            <div class="stimulus-container">
              <div class="left-region"></div>
              <div class="right-region"></div>
              <img src="${img.src}" class="stimulus-image" alt="èº«æå¯¹æ¯”å›¾ç‰‡" />
            </div>
          `;
        },
        trial_duration: 6000,
        choices: "NO_KEYS",
        data: {
          task: 'view',
          phase: 'body',
          block: 'body_presentation',
          image_type: img.type,
          image_attribute: img.attribute,
          image_position: img.position,
          original_index: img.index,
          image_src: img.src,
          trial_index: index + 1,
          total_trials: shuffledBodyImages.length,
          trial_start_time: null, // å°†åœ¨on_startä¸­è®¾ç½®
          gaze_data: null,
          analysisResult: null // å­˜å‚¨åˆ†æç»“æœ
        },
        extensions: [
          {
            type: jsPsychExtensionWebgazer,
            params: { targets: ['.stimulus-container'] }
          }
        ],
        on_start: function(trial) {
          // è®°å½•è¯•æ¬¡å¼€å§‹æ—¶é—´ - ä¿®å¤ç‚¹ï¼šç›´æ¥å­˜å‚¨åˆ°dataå¯¹è±¡
          const startTime = Date.now();
          trial.data.trial_start_time = startTime;
          // åœ¨è¯•æ¬¡å¯¹è±¡ä¸Šå­˜å‚¨å¼€å§‹æ—¶é—´
          this.trial_start_time = startTime;

          // åœ¨å›¾ç‰‡åŠ è½½å®Œæˆåè·å–å®¹å™¨ä½ç½®
          setTimeout(() => {
            const container = document.querySelector('.stimulus-container');
            if (container) {
              const rect = container.getBoundingClientRect();
              containerRect = {
                left: rect.left,
                right: rect.right,
                top: rect.top,
                bottom: rect.bottom
              };
              console.log('å®¹å™¨ä½ç½®ä¿¡æ¯:', containerRect);
            }
          }, 500);

          startGazeTracking(trial.data);
        },
        on_finish: function(data) {
          // ç¡®ä¿å¼€å§‹æ—¶é—´è¢«è®°å½•ï¼ˆä½¿ç”¨è¯•æ¬¡å¯¹è±¡ä¸Šå­˜å‚¨çš„å¼€å§‹æ—¶é—´ï¼‰
          data.trial_start_time = this.trial_start_time;

          // è®°å½•è¯•æ¬¡ç»“æŸæ—¶é—´å’Œçœ¼åŠ¨æ•°æ®
          const endTime = Date.now();
          data.trial_end_time = endTime;

          // ç¡®ä¿æœ‰æœ‰æ•ˆçš„å¼€å§‹æ—¶é—´
          const startTime = this.trial_start_time;
          if (startTime) {
            data.trial_duration_actual = endTime - startTime;
          } else {
            // å¦‚æœå¼€å§‹æ—¶é—´æ— æ•ˆï¼Œä½¿ç”¨çœ¼åŠ¨æ•°æ®çš„ç¬¬ä¸€æ¡æ—¶é—´æˆ³ï¼ˆå¦‚æœæœ‰ï¼‰
            if (gazeData.length > 0) {
              data.trial_start_time = gazeData[0].timestamp;
              data.trial_duration_actual = endTime - data.trial_start_time;
            } else {
              // æ²¡æœ‰çœ¼åŠ¨æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤è¯•æ¬¡æ—¶é•¿
              data.trial_duration_actual = 6000;
            }
          }

          data.gaze_data = stopGazeTracking(); // ä¿å­˜çœ¼åŠ¨æ•°æ®

          // åˆ†æçœ¼åŠ¨æ•°æ®
          if (data.gaze_data && data.gaze_data.length > 0) {
            data.analysisResult = analyzeGazeData(data.gaze_data, data.image_type, data.image_attribute);
            console.log(`è¯•æ¬¡ ${data.trial_index} åˆ†æç»“æœ:`, data.analysisResult);
          } else {
            console.warn(`è¯•æ¬¡ ${data.trial_index} æ— çœ¼åŠ¨æ•°æ®`);
          }
        }
      };
      bodyTrials.push(bodyTrial);

      // è¯•æ¬¡é—´ä¼‘æ¯ï¼ˆæœ€åä¸€ä¸ªè¯•æ¬¡åä¸ä¼‘æ¯ï¼‰
      if (index < shuffledBodyImages.length - 1) {
        bodyTrials.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: '',
          choices: "NO_KEYS",
          trial_duration: 2000,
          data: {
            task: 'rest',
            phase: 'body',
            block: 'body_presentation',
            trial_index: index + 1,
            total_trials: shuffledBodyImages.length
          }
        });
      }
    });

    // æŒ‰é¡ºåºæ·»åŠ åˆ°ä¸»æ—¶é—´çº¿ï¼šå…ˆé£Ÿç‰©è¯•æ¬¡ï¼Œå†è¿‡æ¸¡ï¼Œå†ç¬¬äºŒä¸ªæ ¡å‡†ç¯èŠ‚ï¼Œå†èº«æè¯•æ¬¡
    timeline.push({ timeline: foodTrials });
    timeline.push(phaseTransition);
    timeline.push(second_calibration_instructions);
    timeline.push(second_calibration);
    timeline.push(second_validation_instructions);
    timeline.push(second_validation);
    timeline.push(second_recalibrate);
    timeline.push(second_calibration_done);
    timeline.push({ timeline: bodyTrials });

    /* ==== æ•°æ®å¤„ç†å’ŒGitHubä¸Šä¼  ==== */
    const dataProcessingTrial = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function() {
        return `
          <div class="centered-text">
            <p>å®éªŒå®Œæˆï¼æ­£åœ¨å¤„ç†æ•°æ®...</p>
            <div class="status-message status-loading" id="status-message">
              æ•°æ®è®¡ç®—ä¸­ï¼Œè¯·ç¨å€™...
            </div>
          </div>
        `;
      },
      choices: [],
      on_load: async function() {
        let predictionResult = null;
        let diagnosticReportHTML = ''; // åœ¨æ­¤å¤„å£°æ˜è¯Šæ–­æŠ¥å‘Šå˜é‡
        let reportId = '';
        let reportDate = '';
  try {
    const statusMessage = document.getElementById('status-message');

    // æ”¶é›†æ‰€æœ‰å®éªŒæ•°æ®
    const allData = jsPsych.data.get().filter({task: 'view'}).values();

    // è®¡ç®—çœ¼åŠ¨æ•°æ®ç‚¹æ€»æ•°
    const dataPoints = allData.reduce((total, trial) => {
      return total + (trial.gaze_data ? trial.gaze_data.length : 0);
    }, 0);

    // æ±‡æ€»åˆ†æç»“æœ
    aggregateResults(allData);

// ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹
if (modelLoaded) {
  predictionResult = await predictEatingDisorder(analysisResults);
  console.log('è¿›é£Ÿéšœç¢é¢„æµ‹ç»“æœ:', predictionResult);

  // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
  const reportType = predictionResult.predictedClass === 1 ? 'abnormal' : 'normal';
  reportId = `${userInfo.subjectId}_${userInfo.session}_${Date.now()}`;
  const now = new Date();
  reportDate = `${now.getFullYear()}å¹´${(now.getMonth()+1).toString().padStart(2, '0')}æœˆ${now.getDate().toString().padStart(2, '0')}æ—¥`;

diagnosticReportHTML = diagnosticReports[reportType]
    .replace(/{reportId}/g, reportId)
    .replace(/{reportDate}/g, reportDate)
    .replace(/{subjectId}/g, userInfo.subjectId);

} else {
  console.warn('æ¨¡å‹æœªåŠ è½½ï¼Œè·³è¿‡é¢„æµ‹');
}
          // ç”Ÿæˆç»“æœè¡¨æ ¼
          let resultsTable = generateResultsTable(predictionResult);
          let resultsCSV = generateResultsCSV(predictionResult);

          // ç”ŸæˆCSVæ•°æ®ï¼ˆåŸå§‹æ•°æ®ï¼‰
          const csvData = allData.map(trial => {
            // åŸºç¡€ä¿¡æ¯
            const baseData = {
              trial_id: trial.trial_index,
              phase: trial.phase,
              image_type: trial.image_type,
              image_attribute: trial.image_attribute,
              image_position: trial.image_position,
              original_index: trial.original_index,
              image_src: trial.image_src,
              start_time: trial.trial_start_time,
              end_time: trial.trial_end_time,
              duration: trial.trial_duration_actual
            };

            // å¦‚æœæœ‰çœ¼åŠ¨æ•°æ®ï¼Œæ·»åŠ ç¬¬ä¸€æ¡å’Œæœ€åä¸€æ¡ä½œä¸ºç¤ºä¾‹
            if (trial.gaze_data && trial.gaze_data.length > 0) {
              baseData.first_gaze_x = trial.gaze_data[0].x;
              baseData.first_gaze_y = trial.gaze_data[0].y;
              baseData.last_gaze_x = trial.gaze_data[trial.gaze_data.length - 1].x;
              baseData.last_gaze_y = trial.gaze_data[trial.gaze_data.length - 1].y;
              baseData.gaze_samples = trial.gaze_data.length;
            }

            // æ·»åŠ åˆ†æç»“æœ
            if (trial.analysisResult) {
              baseData.dwell_time = trial.analysisResult.dwellTime;
              baseData.first_fixation = trial.analysisResult.firstFixation;
              baseData.regression_count = trial.analysisResult.regressionCount;
            }

            return baseData;
          });

          // è½¬æ¢ä¸ºCSVå­—ç¬¦ä¸²
          let csvContent = Object.keys(csvData[0]).join(',') + '\n';
          csvData.forEach(row => {
            csvContent += Object.values(row).join(',') + '\n';
          });

          // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
          const jsonContent = JSON.stringify(allData, null, 2);

          // ç”Ÿæˆæ–‡ä»¶åï¼ˆæ–°æ ¼å¼ï¼šcsv_eye-00X_01_part1ï¼‰
          const subjectIdNum = userInfo.subjectId.replace('eye-', '').padStart(3, '0');
          const sessionStr = userInfo.session.toString().padStart(2, '0');
          const timestamp = Date.now(); // æ·»åŠ æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§
          const csvFileName = `csv_eye-${subjectIdNum}_${sessionStr}_${timestamp}.csv`;
          const jsonFileName = `json_eye-${subjectIdNum}_${sessionStr}_${timestamp}.json`;
          const resultsFileName = `results_eye-${subjectIdNum}_${sessionStr}_${timestamp}.csv`;

          // å¦‚æœæ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè·³è¿‡GitHubä¸Šä¼ 
          if (cameraPermissionDenied) {
            statusMessage.className = "status-message status-error";
            statusMessage.textContent = "çœ¼åŠ¨æ•°æ®æœªè®°å½•ï¼ˆæ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼‰";

            // æ˜¾ç¤ºç»“æœè¡¨æ ¼
            document.querySelector('.jspsych-content').innerHTML = `
              <div class="centered-text">
                <h2>ç¬¬ ${userInfo.session} æ¬¡å®éªŒå®Œæˆ</h2>
                <p class="warning">çœ¼åŠ¨æ•°æ®æœªè®°å½•ï¼ˆæ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼‰</p>
                ${resultsTable}
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                  <button class="save-button" id="save-csv-btn">ä¿å­˜CSVåˆ°æœ¬åœ°</button>
                  <button class="save-button" id="save-json-btn">ä¿å­˜JSONåˆ°æœ¬åœ°</button>
                  <button class="save-button" id="save-results-btn">ä¿å­˜ç»“æœè¡¨æ ¼</button>
                  <button class="exit-button" id="exit-btn">é€€å‡ºå®éªŒ</button>
                </div>
              </div>
            `;

            // æ·»åŠ æŒ‰é’®äº‹ä»¶
            document.getElementById('save-csv-btn').addEventListener('click', function() {
              saveCSVToLocal(csvContent, csvFileName);
            });

            document.getElementById('save-json-btn').addEventListener('click', function() {
              saveJSONToLocal(jsonContent, jsonFileName);
            });

            document.getElementById('save-results-btn').addEventListener('click', function() {
              saveCSVToLocal(resultsCSV, resultsFileName);
            });

            document.getElementById('exit-btn').addEventListener('click', function() {
              location.reload();
            });

            return;
          }

          // ä¸Šä¼ æ•°æ®çš„æ ¸å¿ƒå‡½æ•°
          const uploadData = async () => {
            // 1. åˆ›å»ºæˆ–è·å–GitHub Issueï¼ˆæ¯ä¸ªè¢«è¯•åªåˆ›å»ºä¸€ä¸ªï¼‰
            statusMessage.textContent = "è¿æ¥GitHubä»“åº“...";
            const issue = await getOrCreateIssue();

            // 2. ç”ŸæˆGitHubè¯„è®ºå†…å®¹ï¼ˆåŒ…å«é¢„æµ‹ç»“æœï¼‰
            statusMessage.textContent = "ç”Ÿæˆæ•°æ®æŠ¥å‘Š...";
            const commentBody = generateGitHubComment(dataPoints, predictionResult);

            // 3. æ·»åŠ è¯„è®ºåˆ°Issueï¼ˆæ¯æ¬¡çš„æ•°æ®ä½œä¸ºä¸€æ¡è¯„è®ºï¼‰
            statusMessage.textContent = "ä¸Šä¼ æ•°æ®åˆ°GitHub Issues...";
            await addIssueComment(issue.number, commentBody);

            // 4. ä¸Šä¼ CSVæ–‡ä»¶åˆ°data1ç›®å½•ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
            statusMessage.textContent = "ä¸Šä¼ CSVæ–‡ä»¶åˆ°data1ç›®å½•...";
            await uploadFileToGitHub(csvContent, csvFileName, 'data1');

            // 5. ä¸Šä¼ JSONæ–‡ä»¶åˆ°data2ç›®å½•ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
            statusMessage.textContent = "ä¸Šä¼ JSONæ–‡ä»¶åˆ°data2ç›®å½•...";
            await uploadFileToGitHub(jsonContent, jsonFileName, 'data2');

            // 6. ä¸Šä¼ ç»“æœæ–‡ä»¶åˆ°resultsç›®å½•
            statusMessage.textContent = "ä¸Šä¼ ç»“æœæ–‡ä»¶åˆ°resultsç›®å½•...";
            await uploadFileToGitHub(resultsCSV, resultsFileName, 'results');

            // 7. æ›´æ–°æ¬¡æ•°è®°å½•
            localStorage.setItem(`session_${userInfo.subjectId}`, userInfo.session.toString());

            // 8. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            statusMessage.className = "status-message status-success";
            statusMessage.textContent = "æ•°æ®ä¸Šä¼ æˆåŠŸï¼";

            // 9. æ˜¾ç¤ºæ•°æ®æŠ¥å‘Šå’Œæ“ä½œæŒ‰é’®
            let content = `
              <div class="centered-text">
                <h2>ç¬¬ ${userInfo.session} æ¬¡å®éªŒå®Œæˆ</h2>
                <p>è¯¦ç»†çœ¼åŠ¨æ•°æ®å·²æˆåŠŸä¸Šä¼ è‡³GitHubä»“åº“</p>
            `;
            // å¦‚æœæœ‰é¢„æµ‹ç»“æœï¼Œæ˜¾ç¤ºè¯Šæ–­æŠ¥å‘Š
          if (predictionResult && diagnosticReportHTML) {
            content += diagnosticReportHTML;
          }

            content += `
                ${resultsTable}
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                  <button class="copy-button" id="copy-btn">å¤åˆ¶æŠ¥å‘Šæ‘˜è¦</button>
                  <button class="github-button" id="github-btn">æŸ¥çœ‹GitHubè®°å½•</button>
                  <button class="save-button" id="save-csv-btn">ä¿å­˜CSVåˆ°æœ¬åœ°</button>
                  <button class="save-button" id="save-json-btn">ä¿å­˜JSONåˆ°æœ¬åœ°</button>
                  <button class="save-button" id="save-results-btn">ä¿å­˜ç»“æœè¡¨æ ¼</button>
                  <button class="save-button" id="save-report-btn">ä¿å­˜è¯Šæ–­æŠ¥å‘Š</button>
                  <button class="exit-button" id="exit-btn">é€€å‡ºå®éªŒ</button>
                </div>
              </div>
            `;

            document.querySelector('.jspsych-content').innerHTML = content;

            // æ·»åŠ æŒ‰é’®äº‹ä»¶
document.getElementById('copy-btn').addEventListener('click', function() {
  const summary = `è¢«è¯•ID: ${userInfo.subjectId}\nå®éªŒæ¬¡æ•°: ${userInfo.session}\næ•°æ®ç‚¹æ•°é‡: ${dataPoints}\næ–‡ä»¶ä½ç½®: data1/${csvFileName} å’Œ data2/${jsonFileName}`;

  navigator.clipboard.writeText(summary)
    .then(() => alert('æŠ¥å‘Šæ‘˜è¦å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
    .catch(err => console.error('å¤åˆ¶å¤±è´¥:', err));
});

            // GitHubæŸ¥çœ‹æƒé™éªŒè¯
            document.getElementById('github-btn').addEventListener('click', function() {
              const authModal = document.getElementById('auth-modal');
              const authError = document.getElementById('auth-error');
              const authCode = document.getElementById('auth-code');

              // é‡ç½®éªŒè¯çŠ¶æ€
              authError.style.display = 'none';
              authCode.value = '';

              // æ˜¾ç¤ºéªŒè¯å¼¹çª—
              authModal.style.display = 'flex';

              // ç¡®è®¤æŒ‰é’®äº‹ä»¶
              document.getElementById('auth-confirm').onclick = function() {
                if (authCode.value.toLowerCase() === 'eye') {
                  window.open(issue.html_url, '_blank');
                  authModal.style.display = 'none';
                } else {
                  authError.style.display = 'block';
                }
              };

              // è¿”å›æŒ‰é’®äº‹ä»¶
              document.getElementById('auth-cancel').onclick = function() {
                authModal.style.display = 'none';
              };
            });

            // ä¿å­˜CSVåˆ°æœ¬åœ°æŒ‰é’®ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
            document.getElementById('save-csv-btn').addEventListener('click', function() {
              saveCSVToLocal(csvContent, csvFileName);
            });

            // ä¿å­˜JSONåˆ°æœ¬åœ°æŒ‰é’®ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
            document.getElementById('save-json-btn').addEventListener('click', function() {
              saveJSONToLocal(jsonContent, jsonFileName);
            });

            // ä¿å­˜ç»“æœè¡¨æ ¼æŒ‰é’®
            document.getElementById('save-results-btn').addEventListener('click', function() {
              saveCSVToLocal(resultsCSV, resultsFileName);
            });
 // ä¿å­˜è¯Šæ–­æŠ¥å‘ŠæŒ‰é’®äº‹ä»¶å¤„ç†
          if (predictionResult) {
            document.getElementById('save-report-btn').addEventListener('click', function() {
              // åˆ›å»ºæŠ¥å‘Šæ–‡æœ¬å†…å®¹
              let reportText = `è¿›é£Ÿéšœç¢é£é™©çœ¼åŠ¨æµ‹è¯„æŠ¥å‘Š\n`;
              reportText += `æŠ¥å‘Šç¼–å·: REPORT-${reportId}\n`;
              reportText += `æµ‹è¯„æ—¥æœŸ: ${reportDate}\n`;
              reportText += `å§“å: ${userInfo.subjectId}\n\n`;

              if (predictionResult.predictedClass === 1) {
                reportText += `å°Šæ•¬çš„å‚ä¸è€…ï¼Œæ„Ÿè°¢æ‚¨å®Œæˆæœ¬æ¬¡æµ‹è¯„ã€‚æ‚¨çš„æ•´ä½“è¿›é£Ÿéšœç¢é£é™©ç­‰çº§è¯„ä¼°ä¸ºï¼šå¼‚å¸¸ã€‚\n\n`;
                reportText += `æ‚¨çš„æ³¨æ„æ¨¡å¼æ˜¾ç¤ºå‡ºæ˜æ˜¾çš„è¿›é£Ÿéšœç¢è®¤çŸ¥åå·®ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå’¨è¯¢æˆ–è¯„ä¼°ã€‚\n\n`;
                reportText += `å»ºè®®:\n`;
                reportText += `- ä¸“ä¸šå’¨è¯¢ï¼šæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨ä¸å¿ƒç†å’¨è¯¢å¸ˆæˆ–è¾…å¯¼å‘˜è¿›è¡Œä¸€æ¬¡è°ˆè¯ã€‚\n`;
                reportText += `- è¡ŒåŠ¨æ­¥éª¤ï¼šæ‚¨å¯ä»¥è”ç³»ï¼šå…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š12356 æˆ– åŒ—äº¬å¿ƒç†æ´åŠ©çƒ­çº¿ï¼š010-82951332ã€‚\n`;
                reportText += `- é¿å…ç‹¬è‡ªæŒ£æ‰ï¼šä¸ä¸€ä½æ‚¨ä¿¡ä»»çš„æœ‹å‹æˆ–å®¶äººèŠèŠæ‚¨çš„æ„Ÿå—ã€‚\n`;
              } else {
                reportText += `å°Šæ•¬çš„å‚ä¸è€…ï¼Œæ„Ÿè°¢æ‚¨å®Œæˆæœ¬æ¬¡æµ‹è¯„ã€‚æ‚¨çš„æ•´ä½“è¿›é£Ÿéšœç¢é£é™©ç­‰çº§è¯„ä¼°ä¸ºï¼šå¥åº·ã€‚\n\n`;
                reportText += `æ‚¨çš„æ³¨æ„æ¨¡å¼ä¸å¥åº·äººç¾¤ç›¸ä¼¼ï¼Œæœªæ˜¾ç¤ºå‡ºæ˜¾è‘—çš„è¿›é£Ÿéšœç¢ç›¸å…³è®¤çŸ¥åå·®ã€‚\n\n`;
                reportText += `å»ºè®®:\n`;
                reportText += `- ä¿æŒå½“å‰è‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯ã€‚\n`;
                reportText += `- å¯ä»¥é˜…è¯»ç›¸å…³ç§‘æ™®èµ„æ–™ï¼Œå¢è¿›å¯¹å¿ƒç†å¥åº·çš„è®¤è¯†ï¼Œèµ·åˆ°é¢„é˜²ä½œç”¨ã€‚\n`;
                reportText += `- å¦‚æœæ‚¨æœªæ¥æ„Ÿåˆ°å‹åŠ›æˆ–å›°æ‰°ï¼Œéšæ—¶å¯ä»¥é‡æ–°æµ‹è¯„ã€‚\n`;
              }

              reportText += `\nå…è´£å£°æ˜ï¼šæœ¬æŠ¥å‘Šç”±äººå·¥æ™ºèƒ½ç®—æ³•ç”Ÿæˆï¼Œä»…ä½œä¸ºç­›æŸ¥å’Œå‚è€ƒå·¥å…·ï¼Œä¸èƒ½ä½œä¸ºä¸´åºŠè¯Šæ–­çš„å”¯ä¸€ä¾æ®ã€‚\n`;
              reportText += `æœ€ç»ˆçš„è¯Šæ–­å¿…é¡»ç”±åˆæ ¼çš„åŒ»ç–—ä¸“ä¸šäººå‘˜é€šè¿‡é¢è°ˆå’Œè¯„ä¼°åšå‡ºã€‚\n`;

              // ä¿å­˜ä¸ºæ–‡æœ¬æ–‡ä»¶
              const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `è¯Šæ–­æŠ¥å‘Š_${userInfo.subjectId}_${reportDate}.txt`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            });
          }
            // é€€å‡ºå®éªŒæŒ‰é’® - æ”¹ä¸ºåˆ·æ–°é¡µé¢
            document.getElementById('exit-btn').addEventListener('click', function() {
              location.reload(); // åˆ·æ–°é¡µé¢å›åˆ°ç™»å½•ç•Œé¢
            });
          };

          // æ‰§è¡Œä¸Šä¼ 
          await uploadData();

        } catch (error) {
          predictionResult = null;
          const statusMessage = document.getElementById('status-message');
          statusMessage.className = "status-message status-error";
          statusMessage.textContent = `æ•°æ®å¤„ç†å¤±è´¥: ${error.message}`;
          console.error('å®Œæ•´é”™è¯¯ä¿¡æ¯:', error);

          // è·å–æ•°æ®ç”¨äºæœ¬åœ°ä¿å­˜
          const allData = jsPsych.data.get().filter({task: 'view'}).values();

          // æ±‡æ€»åˆ†æç»“æœ
          aggregateResults(allData);

          // ç”Ÿæˆç»“æœè¡¨æ ¼
          const resultsTable = generateResultsTable();
          const resultsCSV = generateResultsCSV();

          // ç”ŸæˆCSVæ•°æ®
          const csvData = allData.map(trial => {
            const baseData = {
              trial_id: trial.trial_index,
              phase: trial.phase,
              image_type: trial.image_type,
              image_attribute: trial.image_attribute,
              image_position: trial.image_position,
              original_index: trial.original_index,
              image_src: trial.image_src,
              start_time: trial.trial_start_time,
              end_time: trial.trial_end_time,
              duration: trial.trial_duration_actual
            };
            if (trial.gaze_data && trial.gaze_data.length > 0) {
              baseData.first_gaze_x = trial.gaze_data[0].x;
              baseData.first_gaze_y = trial.gaze_data[0].y;
              baseData.last_gaze_x = trial.gaze_data[trial.gaze_data.length - 1].x;
              baseData.last_gaze_y = trial.gaze_data[trial.gaze_data.length - 1].y;
              baseData.gaze_samples = trial.gaze_data.length;
            }
            if (trial.analysisResult) {
              baseData.dwell_time = trial.analysisResult.dwellTime;
              baseData.first_fixation = trial.analysisResult.firstFixation;
              baseData.regression_count = trial.analysisResult.regressionCount;
            }
            return baseData;
          });

          let csvContent = Object.keys(csvData[0]).join(',') + '\n';
          csvData.forEach(row => {
            csvContent += Object.values(row).join(',') + '\n';
          });

          const jsonContent = JSON.stringify(allData, null, 2);

          // ç”Ÿæˆæ–°æ ¼å¼æ–‡ä»¶åï¼ˆæ·»åŠ æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§ï¼‰
          const subjectIdNum = userInfo.subjectId.replace('eye-', '').padStart(3, '0');
          const sessionStr = userInfo.session.toString().padStart(2, '0');
          const timestamp = Date.now();
          const csvFileName = `csv_eye-${subjectIdNum}_${sessionStr}_${timestamp}.csv`;
          const jsonFileName = `json_eye-${subjectIdNum}_${sessionStr}_${timestamp}.json`;
          const resultsFileName = `results_eye-${subjectIdNum}_${sessionStr}_${timestamp}.csv`;

          // æ˜¾ç¤ºé”™è¯¯æ¢å¤é€‰é¡¹
          document.querySelector('.jspsych-content').innerHTML += `
            <div class="error-panel">
              <h4>æ•°æ®ä¸Šä¼ å¤±è´¥å¤„ç†æ–¹æ¡ˆ</h4>
              <p>ç³»ç»Ÿæ— æ³•è‡ªåŠ¨ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨ï¼Œè¯·é€‰æ‹©ä»¥ä¸‹æ“ä½œ:</p>
              <p><strong>é”™è¯¯åŸå› :</strong> ${error.message}</p>
              <ul>
                <li>æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•</li>
                <li>ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å¹¶ç¨åæäº¤ç»™å®éªŒè´Ÿè´£äºº</li>
                <li>é€€å‡ºå®éªŒå¹¶é‡æ–°å¼€å§‹</li>
              </ul>
            </div>
            ${resultsTable}
            <div style="margin-top: 20px; text-align: center;">
              <button class="login-button" id="retry-btn">é‡è¯•ä¸Šä¼ </button>
              <button class="save-button" id="save-csv-btn">ä¿å­˜CSVåˆ°æœ¬åœ°</button>
              <button class="save-button" id="save-json-btn">ä¿å­˜JSONåˆ°æœ¬åœ°</button>
              <button class="save-button" id="save-results-btn">ä¿å­˜ç»“æœè¡¨æ ¼</button>
              <button class="exit-button" id="exit-btn">é€€å‡ºå®éªŒ</button>
            </div>
          `;

          // é‡è¯•ä¸Šä¼ æŒ‰é’®
          document.getElementById('retry-btn').addEventListener('click', async () => {
            const statusMessage = document.getElementById('status-message');
            statusMessage.className = "status-message status-loading";
            statusMessage.textContent = "æ­£åœ¨é‡è¯•ä¸Šä¼ æ•°æ®...";

            try {
              // é‡æ–°æ‰§è¡Œä¸Šä¼ é€»è¾‘
              const issue = await getOrCreateIssue();
              const commentBody = generateGitHubComment(dataPoints);
              await addIssueComment(issue.number, commentBody);
              await uploadFileToGitHub(csvContent, csvFileName, 'data1');
              await uploadFileToGitHub(jsonContent, jsonFileName, 'data2');
              await uploadFileToGitHub(resultsCSV, resultsFileName, 'results');

              // æ›´æ–°æ¬¡æ•°è®°å½•
              localStorage.setItem(`session_${userInfo.subjectId}`, userInfo.session.toString());

              statusMessage.className = "status-message status-success";
              statusMessage.textContent = "æ•°æ®ä¸Šä¼ æˆåŠŸï¼";

              // åˆ·æ–°é¡µé¢
              setTimeout(() => location.reload(), 2000);

            } catch (retryError) {
              statusMessage.className = "status-message status-error";
              statusMessage.textContent = `é‡è¯•å¤±è´¥: ${retryError.message}`;
              console.error('é‡è¯•é”™è¯¯ä¿¡æ¯:', retryError);
            }
          });

          // ä¿å­˜CSVæŒ‰é’®ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
          document.getElementById('save-csv-btn').addEventListener('click', function() {
            saveCSVToLocal(csvContent, csvFileName);
            // æ›´æ–°å®éªŒæ¬¡æ•°
            localStorage.setItem(`session_${userInfo.subjectId}`, userInfo.session.toString());
          });

          // ä¿å­˜JSONæŒ‰é’®ï¼ˆä½¿ç”¨æ–°æ–‡ä»¶åæ ¼å¼ï¼‰
          document.getElementById('save-json-btn').addEventListener('click', function() {
            saveJSONToLocal(jsonContent, jsonFileName);
            // æ›´æ–°å®éªŒæ¬¡æ•°
            localStorage.setItem(`session_${userInfo.subjectId}`, userInfo.session.toString());
          });

          // ä¿å­˜ç»“æœè¡¨æ ¼æŒ‰é’®
          document.getElementById('save-results-btn').addEventListener('click', function() {
            saveCSVToLocal(resultsCSV, resultsFileName);
            // æ›´æ–°å®éªŒæ¬¡æ•°
            localStorage.setItem(`session_${userInfo.subjectId}`, userInfo.session.toString());
          });

          // é€€å‡ºå®éªŒæŒ‰é’® - æ”¹ä¸ºåˆ·æ–°é¡µé¢
          document.getElementById('exit-btn').addEventListener('click', function() {
            location.reload(); // åˆ·æ–°é¡µé¢å›åˆ°ç™»å½•ç•Œé¢
          });
        }
      }
    };
// åœ¨timelineå¼€å§‹å‰æ·»åŠ æ¨¡å‹åŠ è½½
const preExperimentSetup = {
  type: jsPsychCallFunction,
  func: async function() {
    console.log('å¼€å§‹åŠ è½½æ¨¡å‹...');
    const modelLoaded = await loadModel();
    if (modelLoaded) {
      console.log('æ¨¡å‹åŠ è½½æˆåŠŸ');
    } else {
      console.warn('æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œé¢„æµ‹åŠŸèƒ½å°†ä¸å¯ç”¨');
    }
  }
};
// å°†preExperimentSetupæ·»åŠ åˆ°timelineå¼€å¤´
timeline.unshift(preExperimentSetup);

// æ•°æ®å¤„ç†å’ŒGitHubä¸Šä¼ 
timeline.push(dataProcessingTrial);

/* ==== è¿è¡Œå®éªŒ ==== */
jsPsych.run(timeline);
  </script>
</body>
</html>
